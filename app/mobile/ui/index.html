<!--
  文件职责：
  1. 定义移动端（Tauri WebView）调试与运维 UI 的结构、样式与交互。
  2. 维护与 relay 的 WebSocket 会话，并展示宿主机与工具快照。
  3. 提供候选工具接入、工具详情查看和调试日志入口。
-->
<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <title>yourConnector Mobile</title>
    <link rel="stylesheet" href="./styles/base.css" />
    <link rel="stylesheet" href="./styles/layout.css" />
    <link rel="stylesheet" href="./styles/components.css" />
    <link rel="stylesheet" href="./styles/modals.css" />
    <link rel="stylesheet" href="./styles/tools.css" />
  </head>
  <body>
    <div class="app">
      <header class="topbar">
        <div class="top-actions">
          <button id="connectBtnTop" class="btn btn-primary btn-sm">连接全部宿主机</button>
          <button id="disconnectBtnTop" class="btn btn-outline btn-sm" disabled>断开全部</button>
          <button id="replaceHostBtnTop" class="btn btn-outline btn-sm">更换宿主机</button>
        </div>
      </header>

      <section id="opsView" class="view active">
        <article id="hostSetupCard" class="glass-card status-card host-setup">
          <h2 class="section-title" style="margin-top: 0">配对宿主机</h2>
          <p class="host-setup-tip">首次使用请先导入配对链接；无法扫码时可进入手动配对页填写 Relay、sid 与 ticket。</p>
          <div class="host-setup-actions">
            <button id="importPairLinkBtn" class="btn btn-primary">导入配对链接</button>
            <button id="openManualPairBtn" class="btn btn-outline">手动填写配对信息</button>
            <button id="openDebugFromSetupBtn" class="btn btn-outline">打开调试入口</button>
          </div>
        </article>

        <div id="hostOverviewWrap" class="ops-body hidden">
          <article class="glass-card status-card">
            <h2 class="section-title" style="margin-top: 0">Host Snapshot</h2>
            <div id="hostBannerTrack" class="host-banner-track"></div>
            <div id="hostBannerDots" class="host-banner-dots"></div>
          </article>

          <div class="section-head">
            <h2 class="section-title">Connected Tools</h2>
          </div>
          <p class="section-sub">按宿主机分组展示每台宿主机已接入工具；工具卡片左滑可编辑名称或删除接入。</p>
          <div id="toolsGroupedList" class="tools"></div>
        </div>
      </section>

      <section id="debugView" class="view">
        <article class="glass-card status-card debug-panel">
          <div id="debugStatus" class="debug-stats">Status: Disconnected</div>
          <div id="debugEvents" class="debug-stats">Events IN: 0 · OUT: 0</div>

          <div class="field">
            <label for="debugHostSelect">调试宿主机</label>
            <select id="debugHostSelect"></select>
          </div>
          <div id="debugIdentity" class="debug-stats"></div>

          <div class="debug-actions">
            <button id="connectBtnDebug" class="btn btn-primary">连接当前宿主机</button>
            <button id="disconnectBtnDebug" class="btn btn-outline" disabled>断开当前宿主机</button>
          </div>
          <button id="rebindControllerBtn" class="btn btn-outline">
            绑定当前设备为控制端
          </button>

          <div class="field">
            <label for="messageInput">Test Message</label>
            <input id="messageInput" type="text" />
          </div>

          <button id="sendBtn" class="btn btn-primary">Send Test Event</button>

          <div class="field">
            <label>Logs</label>
            <div id="logBox" class="log-box"></div>
          </div>
        </article>
      </section>
    </div>

    <nav class="tabs">
      <button id="tabOps" class="tab-btn active">运维</button>
      <button id="tabDebug" class="tab-btn">调试入口</button>
    </nav>

    <div id="toolModal" class="modal">
      <div class="modal-card">
        <div class="modal-top">
          <h3 id="toolModalTitle">Tool Detail</h3>
          <button id="toolModalClose" class="icon-btn" aria-label="关闭">×</button>
        </div>

        <section class="detail-card">
          <h4 class="detail-title">OpenCode 摘要</h4>
          <div id="summaryRows" class="rows"></div>
        </section>

        <section class="detail-card">
          <div class="expand-head">
            <span class="title">更多信息</span>
            <button id="toggleDetailsBtn" class="icon-btn" aria-label="展开或收起">⌄</button>
          </div>
          <div id="detailRows" class="rows" style="margin-top: 8px"></div>
          <p id="detailTip" class="expand-tip"></p>
        </section>

        <section id="usagePanel" class="detail-card" style="display: none">
          <h4 class="detail-title">模型用量（当前会话）</h4>
          <div id="usageRows" class="rows"></div>
        </section>
      </div>
    </div>

    <div id="addToolModal" class="modal">
      <div class="modal-card">
        <div class="modal-top">
          <h3>添加 AI 工具</h3>
          <button id="addToolModalClose" class="icon-btn" aria-label="关闭">×</button>
        </div>

        <p class="section-sub" style="margin-top: 8px">
          这里展示 sidecar 自动发现但尚未接入白名单的候选工具，点击接入后才会出现在 Connected Tools。
        </p>

        <section class="detail-card">
          <h4 class="detail-title">候选工具</h4>
          <div id="candidateList" class="candidate-list"></div>
        </section>

        <section class="detail-card">
          <h4 class="detail-title">接入提示</h4>
          <div class="rows">
            <div class="row"><div class="k">OpenCode</div><div class="v">在宿主机终端执行 `opencode`，保持会话运行</div></div>
            <div class="row"><div class="k">OpenClaw</div><div class="v">按宿主机上的启动方式运行 openclaw，等待 sidecar 自动发现</div></div>
          </div>
        </section>

        <button id="goDebugFromAddTool" class="btn btn-outline" style="width: 100%">
          打开调试页查看连接参数
        </button>
      </div>
    </div>

    <div id="pairFlowModal" class="modal">
      <div class="modal-card">
        <div class="modal-top">
          <h3 id="pairFlowTitle">导入配对链接</h3>
          <button id="pairFlowClose" class="icon-btn" aria-label="关闭">×</button>
        </div>

        <section id="pairFlowStepImport" class="detail-card">
          <h4 class="detail-title">选择导入方式</h4>
          <p class="section-sub" style="margin: 0 0 12px">
            扫码与粘贴链接会在校验通过后直接配对并连接宿主机。
          </p>
          <div class="host-setup-actions">
            <button id="pairOpenScanBtn" class="btn btn-primary">导入/扫描二维码配对</button>
            <button id="pairOpenPasteBtn" class="btn btn-outline">粘贴配对链接以配对</button>
          </div>
        </section>

        <section id="pairFlowStepPaste" class="detail-card" style="display: none">
          <h4 class="detail-title">粘贴配对链接</h4>
          <div class="field">
            <label for="pairLinkInput">配对链接（yc://pair?...）</label>
            <input id="pairLinkInput" type="text" placeholder="粘贴扫码结果或 yc://pair 链接" />
          </div>
          <div class="host-setup-actions" style="margin-top: 10px">
            <button id="pairPasteSubmitBtn" class="btn btn-primary">配对并连接</button>
            <button id="pairPasteBackBtn" class="btn btn-outline">返回</button>
          </div>
        </section>

        <section id="pairFlowStepScan" class="detail-card" style="display: none">
          <h4 class="detail-title">扫码配对</h4>
          <p class="section-sub" style="margin: 0 0 8px">
            对准 sidecar/relay 展示的二维码，识别成功后将自动配对并连接。
          </p>
          <p id="pairScanStatus" class="section-sub" style="margin: 0 0 8px; min-height: 20px"></p>
          <div style="border: 1px solid var(--line-soft); border-radius: 14px; overflow: hidden; background: rgba(2, 10, 20, 0.76)">
            <video id="pairScanVideo" autoplay playsinline muted style="width: 100%; height: 220px; object-fit: cover"></video>
          </div>
          <input id="pairScanFileInput" type="file" accept="image/*" style="display: none" />
          <div class="host-setup-actions" style="margin-top: 10px">
            <button id="pairScanGalleryBtn" class="btn btn-outline">从图库导入二维码</button>
            <button id="pairScanBackBtn" class="btn btn-outline">返回</button>
          </div>
        </section>

        <section id="pairFlowStepManual" class="detail-card" style="display: none">
          <h4 class="detail-title">手动填写配对信息</h4>
          <div class="field">
            <label for="hostRelayInput">Relay WS URL</label>
            <input id="hostRelayInput" type="text" />
          </div>
          <div class="field" style="margin-top: 8px">
            <label for="hostSystemIdInput">System ID（sid）</label>
            <input id="hostSystemIdInput" type="text" placeholder="例如 sys_xxx" />
          </div>
          <div class="field" style="margin-top: 8px">
            <label for="hostPairTicketInput">配对票据（ticket）</label>
            <input id="hostPairTicketInput" type="text" placeholder="例如 pct_v1.xxxxxx.yyyyyy" />
          </div>
          <div class="field" style="margin-top: 8px">
            <label for="hostNameInput">宿主机名称（可修改）</label>
            <input id="hostNameInput" type="text" placeholder="例如 我的 MacBook Pro" />
          </div>
          <div class="host-setup-actions" style="margin-top: 10px">
            <button id="pairManualSubmitBtn" class="btn btn-primary">配对并连接</button>
            <button id="pairManualBackBtn" class="btn btn-outline">返回</button>
          </div>
        </section>
      </div>
    </div>

    <div id="pairFailureModal" class="modal">
      <div class="modal-card">
        <div class="modal-top">
          <h3>配对失败</h3>
          <button id="pairFailureClose" class="icon-btn" aria-label="关闭">×</button>
        </div>
        <section class="detail-card">
          <h4 id="pairFailureReason" class="detail-title" style="font-size: 16px">失败原因</h4>
          <p id="pairFailureSuggestion" class="section-sub" style="margin: 0">建议下一步</p>
          <div class="host-setup-actions" style="margin-top: 12px">
            <button id="pairFailurePrimaryBtn" class="btn btn-primary">重试</button>
            <button id="pairFailureSecondaryBtn" class="btn btn-outline">关闭</button>
          </div>
        </section>
      </div>
    </div>

    <div id="hostManageModal" class="modal">
      <div class="modal-card">
        <div class="modal-top">
          <h3>宿主机管理</h3>
          <button id="hostManageClose" class="icon-btn" aria-label="关闭">×</button>
        </div>
        <section class="detail-card">
          <h4 class="detail-title">已配对宿主机</h4>
          <div id="hostManageList" class="host-manage-list"></div>
        </section>
        <section class="detail-card">
          <h4 class="detail-title">删除补偿队列</h4>
          <p class="section-sub" style="margin: 0 0 8px">Relay 不可达时会先隐藏宿主机并进入补偿队列，恢复连通后自动删除。</p>
          <div id="pendingDeleteList" class="host-manage-list"></div>
        </section>
        <div class="host-setup-actions" style="margin-top: 10px">
          <button id="hostManageAddBtn" class="btn btn-primary">添加宿主机</button>
          <button id="hostManageDebugBtn" class="btn btn-outline">打开调试入口</button>
        </div>
      </div>
    </div>

    <div id="hostEditModal" class="modal">
      <div class="modal-card">
        <div class="modal-top">
          <h3>修改宿主机信息</h3>
          <button id="hostEditClose" class="icon-btn" aria-label="关闭">×</button>
        </div>
        <section class="detail-card">
          <div class="field">
            <label for="hostEditNameInput">宿主机名称</label>
            <input id="hostEditNameInput" type="text" placeholder="例如 我的 MacBook Pro" />
          </div>
          <div class="field" style="margin-top: 8px">
            <label for="hostEditNoteInput">备注</label>
            <input id="hostEditNoteInput" type="text" placeholder="例如 工作机 / 家里主机" />
          </div>
          <div class="host-setup-actions" style="margin-top: 12px">
            <button id="hostEditSaveBtn" class="btn btn-primary">保存修改</button>
            <button id="hostEditCancelBtn" class="btn btn-outline">取消</button>
          </div>
        </section>
      </div>
    </div>

    <div id="hostMetricsModal" class="modal">
      <div class="modal-card">
        <div class="modal-top">
          <h3 id="hostMetricsTitle">宿主机负载</h3>
          <button id="hostMetricsClose" class="icon-btn" aria-label="关闭">×</button>
        </div>

        <section class="detail-card">
          <h4 class="detail-title">系统负载</h4>
          <div id="hostMetricsRows" class="rows"></div>
        </section>

        <section class="detail-card">
          <h4 class="detail-title">Sidecar 负载</h4>
          <div id="hostSidecarRows" class="rows"></div>
        </section>

        <p id="hostMetricsTip" class="section-sub" style="margin: 8px 2px 0"></p>
      </div>
    </div>

    <div id="hostNoticeModal" class="modal">
      <div class="modal-card">
        <div class="modal-top">
          <h3>提示</h3>
          <button id="hostNoticeClose" class="icon-btn" aria-label="关闭">×</button>
        </div>
        <section class="detail-card">
          <h4 id="hostNoticeTitle" class="detail-title" style="font-size: 16px">宿主机名称重复</h4>
          <p id="hostNoticeBody" class="section-sub" style="margin: 0">建议立即修改名称，避免后续识别困难。</p>
          <div class="host-setup-actions" style="margin-top: 12px">
            <button id="hostNoticePrimaryBtn" class="btn btn-primary">去修改名称</button>
            <button id="hostNoticeSecondaryBtn" class="btn btn-outline">稍后处理</button>
          </div>
        </section>
      </div>
    </div>
    <script type="module" src="./js/main.js"></script>
  </body>
</html>
