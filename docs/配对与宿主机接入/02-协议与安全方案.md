# yourConnector 配对与宿主机接入：协议与安全方案

## 1. 目标

1. 配对成功后立即换发设备凭证，不再依赖长期 `pairToken` 建立 App 会话。
2. 支持多宿主并行在线，连接状态互不污染。
3. 提供刷新、吊销、设备列表等完整会话治理能力。

## 2. 核心对象

1. `systemId`：宿主机标识。
2. `pairToken`：sidecar 内部配对令牌（仅 sidecar/relay 使用）。
3. `pairTicket`：短时票据（默认 300 秒，范围 30-3600 秒）。
4. `accessToken`：短期访问令牌（默认 600 秒）。
5. `refreshToken`：刷新令牌（默认 30 天，刷新时轮换）。
6. `keyId + devicePubKey`：设备密钥身份。

## 3. API 约定

### 3.1 配对签发

1. `POST /v1/pair/bootstrap`
2. 入参：`systemId`, `pairToken`, `hostName?`, `relayWsUrl?`, `includeCode?`, `ttlSec?`
3. 出参：`pairLink`, `pairTicket`, `relayWsUrl`, `systemId`, `hostName`, `pairCode?`, `simctlCommand`

### 3.2 配对阶段

1. `POST /v1/pair/preflight`
2. 入参：`systemId`, `deviceId`, `pairTicket`
3. 出参：`authMode`

4. `POST /v1/pair/exchange`
5. 入参：`systemId`, `deviceId`, `deviceName`, `pairTicket`, `keyId`, `devicePubKey`, `proof`
6. 出参：`accessToken`, `refreshToken`, `keyId`, `credentialId`, `accessExpiresInSec`, `refreshExpiresInSec`

### 3.3 会话阶段

1. `POST /v1/auth/refresh`
2. `POST /v1/auth/revoke-device`
3. `GET /v1/auth/devices`

## 4. WS 鉴权

1. App 链路：`accessToken + keyId + ts + nonce + sig`。
2. 签名 payload：`ws\n{systemId}\n{deviceId}\n{keyId}\n{ts}\n{nonce}`。
3. sidecar 链路：`pairToken`。
4. App 传入 `pairToken/pairTicket` 直连 WS 会被拒绝（`PAIR_TOKEN_NOT_SUPPORTED`）。

## 5. 票据与防重放

1. `pairTicket` 采用签名票据格式并携带 `nonce`。
2. 校验包含签名、时效、`sid` 匹配、nonce 重放检测。
3. 预检可不消费票据；换发必须消费票据。

## 6. 存储边界

1. `localStorage`：仅保存宿主机配置与补偿队列元数据。
2. 安全存储（Keychain/等效）：保存 `accessToken/refreshToken/keyId/credentialId`。
3. 禁止在 `localStorage` 写入 `pairToken/accessToken/refreshToken`。

## 7. 错误码重点

1. `PAIR_TICKET_INVALID`：票据格式或签名不合法。
2. `PAIR_TICKET_EXPIRED`：票据过期。
3. `PAIR_TICKET_REPLAYED`：票据重放。
4. `PAIR_TOKEN_NOT_SUPPORTED`：App 仍走旧配对参数。
5. `SYSTEM_NOT_REGISTERED`：宿主机未在线。
6. `DEVICE_REVOKED`：设备已吊销或不可用。

## 8. 相关协议扩展

1. 工具详情：`tool_details_refresh_request/tool_details_snapshot`。
2. 聊天流：`tool_chat_*`。
3. 报告流：`tool_report_fetch_*`。
