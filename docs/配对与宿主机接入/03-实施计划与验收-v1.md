# yourConnector 配对与宿主机接入：实施计划与验收 v1

## 1. 本轮范围

1. Mobile 端改造为多宿主机模型（含删除补偿队列）。
2. 总览页改造为 Banner + 白点 + Tools 分组。
3. 并行在线与重连策略接入（2 秒间隔，5 次上限）。
4. 管理页与编辑页接入（更换宿主机入口）。
5. 配对签发统一到 relay（`/v1/pair/bootstrap`）。
6. Mobile UI 从单文件内联脚本拆分为 ES Modules + 外部样式文件。
7. 文档与验收清单同步更新。

## 2. 实施拆分

### 2.1 S1 文档对齐

1. 更新用户流程文档（页面 A/B/C/D、交互规则、补偿策略）。
2. 更新协议文档（多宿主数据模型、补偿元数据、存储边界）。
3. 更新验收文档（Banner、分组、重连、补偿）。

### 2.2 S2 状态模型升级

1. 从单宿主配置升级到 `HostProfile[]`。
2. 新增 `pendingHostDeletes[]` 持久化。
3. `runtime` 改为按 `hostId` 管理。

### 2.3 S3 页面重构

1. 无宿主机显示首次配对页。
2. 有宿主机显示 Banner 总览页。
3. Banner 下白点显示当前索引。
4. Tools 按宿主机分组展示。

### 2.4 S4 连接策略

1. 启动自动连接全部宿主机。
2. 心跳更新每台宿主机在线状态。
3. 断线按 2 秒重连，失败 5 次后停止并提示手动重连。

### 2.5 S5 管理与补偿

1. 更换宿主机入口进入管理页。
2. 编辑页支持改名与备注。
3. 删除失败时隐藏宿主机并入补偿队列。
4. 补偿成功后清理本地会话并彻底删除。

### 2.6 S6 配对签发收口

1. relay 新增 `POST /v1/pair/bootstrap`。
2. sidecar banner 改为调用 relay 签发接口获取配对链接。
3. `scripts/pairing.sh` 改为 relay 签发，不再本地生成 `pairTicket`。
4. `show-pairing` / `simulate-ios-scan` 与 sidecar 展示同源。

### 2.7 S7 前端文件模块化

1. `index.html` 只保留结构骨架，不再包含内联脚本与内联样式。
2. 样式拆分到 `styles/*`，脚本拆分到 `js/main.js + js/state/services/utils/*`。
3. 预留 `views/flows/modals` 模块目录，持续拆分页面逻辑。

## 3. 验收清单

### 3.1 展示与交互

1. B01 无宿主机时展示配对页。
2. B02 有宿主机时展示 Banner 总览页。
3. B03 Banner 可横向滑动。
4. B04 Banner 下白点正确显示当前索引。
5. B05 Banner 卡片只显示宿主机名与在线状态。
6. B06 Tools 按宿主机分组展示。
7. B07 分组顺序按认证时间 `pairedAt` 升序。
8. B07-1 已接入工具支持左滑显示“编辑/删除”操作。

### 3.2 连接行为

1. B08 启动后自动连接全部宿主机。
2. B09 手动断开后按 2 秒节奏自动重连。
3. B10 连续失败 5 次后停止自动重连并提示手动。
4. B11 手动重连后可恢复在线。

### 3.3 配对与命名

1. B12 扫码/图库/粘贴/手动四入口都可独立配对（手动输入为 `Relay + sid + ticket`）。
2. B13 配对失败统一弹窗展示原因与建议。
3. B14 检测到重名时弹出改名引导，不阻断连接。
4. B14-1 传入 `pairToken` 时应明确返回 `PAIR_TOKEN_NOT_SUPPORTED`。

### 3.4 删除补偿

1. B15 Relay 可达时删除立即完成。
2. B16 Relay 不可达时宿主机先隐藏并进入补偿队列。
3. B17 补偿队列可看到状态与手动重试入口。
4. B18 Relay 恢复后补偿成功并最终删除。

### 3.5 安全边界

1. B19 localStorage 不包含 `pairToken/accessToken/refreshToken`。
2. B20 会话凭证仍通过 Keychain 读写。

### 3.6 配对签发一致性

1. B21 relay `/v1/pair/bootstrap` 正常返回 `pairLink/pairTicket/simctlCommand`。
2. B22 sidecar banner 与 `make show-pairing-link` 的 `relay/sid/name` 一致。
3. B23 `make simulate-ios-scan` 可直接投递 relay 签发链接。

## 4. 调试命令

1. `make run-relay`
2. `make run-sidecar`
3. `make show-pairing`
4. `make simulate-ios-scan`
5. `make run-mobile-tauri-ios`

## 5. 当前限制

1. 本轮以单宿主开发环境为主，多宿主联调后置到第二台宿主机。
2. 多宿主自动化回归暂不纳入本轮。
