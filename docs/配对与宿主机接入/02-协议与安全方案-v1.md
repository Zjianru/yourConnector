# yourConnector 配对与宿主机接入：协议与安全方案 v1

## 1. 目标

1. 配对成功后立即换发设备凭证，不再依赖长期 `pairToken` 建立会话。
2. 支持多宿主机并行在线，保证连接状态互不污染。
3. 删除宿主机支持最终一致性补偿：Relay 暂不可达时先隐藏、后补偿吊销。
4. 继续保证 relay 仅持久化认证元数据，不落业务消息。

## 2. 核心对象

1. `systemId`：宿主机标识。
2. `pairToken`：sidecar 长期配对令牌（仅 sidecar/relay 内部使用，不再作为 App 入参）。
3. `pairTicket`：短时票据（默认 300 秒）。
4. `accessToken`：短期设备访问令牌（默认 600 秒）。
5. `refreshToken`：刷新令牌（默认 30 天，刷新即轮换）。
6. `keyId + devicePubKey`：设备公钥身份，用于 PoP 签名。

## 3. API 约定（不新增破坏性接口）

### 3.1 配对阶段

1. `POST /v1/pair/preflight`
- 入参：`systemId`, `deviceId`, `pairTicket`
- 出参：`ok`, `code`, `message`, `suggestion`, `data.authMode`

2. `POST /v1/pair/exchange`
- 入参：`systemId`, `deviceId`, `deviceName`, `pairTicket`, `keyId`, `devicePubKey`, `proof`
- 出参：`accessToken`, `refreshToken`, `keyId`, `credentialId`, `accessExpiresInSec`, `refreshExpiresInSec`

### 3.2 会话阶段

1. `POST /v1/auth/refresh`
2. `POST /v1/auth/revoke-device`
3. `GET /v1/auth/devices`

## 4. WS 鉴权

1. App 链路固定：`accessToken + keyId + ts + nonce + sig`。
2. 签名 payload：`ws\n{systemId}\n{deviceId}\n{keyId}\n{ts}\n{nonce}`。
3. sidecar 链路固定：`pairToken`（仅 sidecar 握手使用）。

## 5. 移动端本地模型

## 5.1 HostProfile

1. `hostId`
2. `systemId`
3. `relayUrl`
4. `displayName`
5. `note`
6. `pairedAt`
7. `updatedAt`
8. `autoConnect`

## 5.2 HostRuntime（内存态）

1. `status`（DISCONNECTED/CONNECTING/CONNECTED/AUTH_EXPIRED/RELAY_UNREACHABLE）
2. `socket`
3. `retryCount`
4. `heartbeatAt`
5. `lastError`
6. `tools`
7. `systemMetrics`

## 5.3 ToolMeta（本地可持久化）

1. `toolAliases`：键为 `hostId::toolId`，值为用户自定义工具名称。
2. `toolVisibility`：键为 `hostId::toolId`，值为 `hidden`（用于断开后本地隐藏）。

## 5.4 删除补偿队列（持久化，非敏感）

`pendingHostDeletes[]` 字段：

1. `hostId`
2. `systemId`
3. `relayUrl`
4. `displayName`
5. `deviceId`
6. `enqueuedAt`
7. `retryCount`
8. `nextRetryAt`
9. `lastError`

## 6. 存储边界

1. `localStorage`：仅持久化宿主机配置与删除补偿元数据。
2. `Keychain`：`accessToken/refreshToken/keyId/credentialId`。
3. 禁止在 `localStorage` 落地 `pairToken/accessToken/refreshToken`。

## 7. 并行在线与重连策略

1. 启动后自动连接全部已配对宿主机。
2. 断线后每 2 秒重连一次。
3. 连续失败 5 次后停止自动重连，转为“需手动重连”。
4. 手动重连后重置失败计数。

## 8. 删除最终一致性补偿

1. 删除请求优先尝试在线吊销。
2. 吊销失败或 Relay 不可达时：
- 先从主页面隐藏。
- 入补偿队列。
- 后台周期重试 `revoke-device`。
3. 补偿成功后清理本地 Keychain 会话与宿主机配置。

## 9. 错误码映射（关键）

1. `INVALID_LINK`：链接无效。
2. `PAIR_TICKET_EXPIRED` / `PAIR_TICKET_REPLAYED`：需重新扫码。
3. `SYSTEM_NOT_REGISTERED`：宿主机未在线。
4. `RELAY_UNREACHABLE`：Relay 不可达。
5. `PAIR_TOKEN_NOT_SUPPORTED`：客户端仍在使用旧 pairToken 配对参数。
6. `ACCESS_TOKEN_EXPIRED/INVALID`：设备凭证失效。
7. `DEVICE_REVOKED`：设备已吊销。
