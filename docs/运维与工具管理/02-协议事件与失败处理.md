# yourConnector 运维与工具管理：协议事件与失败处理

## 1. 事件矩阵

### 1.1 App -> Sidecar（运维相关）

1. `tools_refresh_request`
2. `tool_connect_request`
3. `tool_disconnect_request`
4. `tool_whitelist_reset_request`
5. `tool_process_control_request`
6. `controller_rebind_request`
7. `tool_details_refresh_request`

### 1.2 Sidecar -> App（运维相关）

1. `heartbeat`
2. `tools_snapshot`
3. `tools_candidates`
4. `metrics_snapshot`
5. `tool_whitelist_updated`
6. `tool_process_control_updated`
7. `controller_bind_updated`
8. `tool_details_snapshot`

事件常量来源：`services/sidecar/src/control.rs` `services/sidecar/src/session/snapshots.rs`。

## 2. 工具接入失败收敛策略

处理入口：`app/mobile/ui/js/flows/connection-events.js` `handleToolWhitelistUpdated()`。

1. 权限类失败（未绑定控制端等）触发一次自动重绑并重试接入。
2. 候选快照延迟类失败触发一次自动刷新候选并重试接入。
3. 每个工具自动重试最多 1 次（`toolConnectRetryCount[toolId] < 1`）。
4. 超过自动重试次数后转人工提示弹窗。

## 3. 工具进程控制失败策略

发送入口：`app/mobile/ui/js/flows/tool-manage.js` `requestToolProcessControl()`。

约束：

1. 仅允许 OpenClaw/OpenCode 两类工具执行进程控制。
2. `restart` 仅允许 OpenClaw；OpenCode 收到 `restart` 会前置拦截提示。
3. Sidecar 回执事件为 `tool_process_control_updated`，失败时带 `reason`。

服务端执行与回执：`services/sidecar/src/session/loop/command.rs`。

## 4. 控制端重绑失败策略

1. `controller_bind_updated.ok=false` 时展示“当前设备未授权”提示。
2. `ok=true && changed=true` 表示重绑成功。
3. `ok=true && changed=false` 表示当前设备本就已是控制端。

对应代码：`app/mobile/ui/js/flows/connection-events.js` `handleControllerBindUpdated()`。

## 5. 删除补偿错误分级

终态 Relay 错误码集合：

1. `SYSTEM_NOT_REGISTERED`
2. `DEVICE_REVOKED`
3. `DEVICE_NOT_FOUND`
4. `REFRESH_TOKEN_INVALID`
5. `REFRESH_TOKEN_EXPIRED`

规则：

1. `DELETE_COMPENSATION_STALE`：发现该宿主机已重新配对，删除旧补偿任务。
2. `DELETE_COMPENSATION_TERMINAL` / `DELETE_COMPENSATION_NO_SESSION`：本地收口后终止重试。
3. 其他错误归为可重试错误，继续按 2 秒间隔重试。

对应代码：`app/mobile/ui/js/flows/host-delete-errors.js` `app/mobile/ui/js/flows/host-delete-remote.js`。
