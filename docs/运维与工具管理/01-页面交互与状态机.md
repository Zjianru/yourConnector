# yourConnector 运维与工具管理：页面交互与状态机

## 1. 页面组成

### 1.1 顶部动作区

按钮定义与可用性规则：

1. `连接全部`：仅当存在可连接宿主机时可点击。
2. `断开全部`：仅当至少一台宿主机已连接时可点击。
3. `更换宿主机`：始终可点击，打开宿主管理弹窗。

对应代码：`app/mobile/ui/js/views/ops.js`。

### 1.2 宿主机 Banner

1. 无宿主机：展示配对引导卡（`hostSetupCard`）。
2. 有宿主机：展示横向 Banner 与白点索引。
3. 点击 Banner 卡片：打开宿主机负载弹窗。
4. 滑动 Banner：按视觉中心计算当前 active 索引并更新白点。

对应代码：`app/mobile/ui/js/views/banner.js` `app/mobile/ui/js/views/ops.js`。

### 1.3 工具分组区

1. 工具按宿主机分组展示。
2. 工具卡片支持左滑操作（改名、删除）。
3. 卡片快捷按钮：OpenClaw 支持 `重启 + 停止`，OpenCode 仅 `停止`。
4. 左滑操作区展开时，低优先级快照（如 `metrics_snapshot`）延迟重渲染，避免误触。

对应代码：`app/mobile/ui/js/views/tools.js` `app/mobile/ui/js/flows/tool-manage.js`。

## 2. 连接状态机

### 2.1 宿主机连接状态

状态字段位于 `runtime.status` 与辅助字段：

1. `CONNECTING`
2. `CONNECTED`
3. `DISCONNECTED`
4. `RELAY_UNREACHABLE`
5. `AUTH_EXPIRED`
6. `manualReconnectRequired=true`（需手动重连）

状态文案映射见 `app/mobile/ui/js/state/runtime.js` `hostStatusLabel()`。

### 2.2 自动重连策略

固定参数：

1. `RECONNECT_INTERVAL_MS = 2000`
2. `MAX_RECONNECT_ATTEMPTS = 5`

行为：

1. 连接关闭或失败后触发 `scheduleReconnect`。
2. 达到 5 次后设置 `manualReconnectRequired=true`，停止自动重连。
3. 用户手动重连会重置计数。

对应代码：`app/mobile/ui/js/flows/connection-socket.js`。

### 2.3 连接世代保护

1. 每次连接尝试提升 `connectionEpoch`。
2. `open/message/close/error` 处理前校验 `connectionEpoch + socket` 是否仍匹配。
3. 旧连接事件会被忽略，防止污染当前运行态。

对应代码：`app/mobile/ui/js/flows/connection-socket-events.js`。

## 3. 宿主管理与删除补偿

### 3.1 管理弹窗能力

1. 连接/重连/断开。
2. 编辑名称与备注。
3. 重新配对。
4. 删除宿主机。
5. 打开宿主机调试视图。
6. 查看并操作“删除补偿任务”。

对应代码：`app/mobile/ui/js/flows/host-manage.js`。

### 3.2 删除补偿流程

1. 先发送工具断开与白名单清空请求（若宿主机在线）。
2. 从 UI 立即移除宿主机并入队 `pendingHostDeletes`。
3. 后台按 `DELETE_RETRY_INTERVAL_MS = 2000` 轮询重试。
4. 终态错误或 stale 任务会自动移出队列。

对应代码：`app/mobile/ui/js/flows/host-delete.js`。
