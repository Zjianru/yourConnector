# yourConnector 架构与数据流

## 1. 目标与边界

1. 目标：让移动端安全连接多台宿主机，并统一管理宿主机工具能力。
2. 边界：Relay 只负责配对/鉴权/转发，不执行工具命令；工具执行全部在 Sidecar。
3. 当前工具：`OpenClaw`、`OpenCode`。

## 2. 核心组件

1. `Mobile App`（`app/mobile`）：多宿主管理、连接、聊天、报告、调试。
2. `Relay`（`services/relay`）：HTTP API、WS 接入鉴权、按 `systemId` 路由。
3. `Sidecar`（`services/sidecar`）：工具发现、详情采集、控制执行、聊天与报告任务。
4. `Protocol`（`protocol/rust`）：共享 envelope 与 payload 结构。

## 3. 关键数据流

### 3.1 配对与凭证换发

1. Sidecar 或配对脚本调用 `POST /v1/pair/bootstrap` 生成 `yc://pair` 链接。
2. App 解析链接后调用：`/v1/pair/preflight` -> `/v1/pair/exchange`。
3. Relay 返回 `accessToken/refreshToken/keyId/credentialId`。
4. App 将会话写入安全存储（Tauri 命令 `auth_store_session`）。

### 3.2 WebSocket 连接

1. App 使用 `accessToken + keyId + ts + nonce + sig` 连接 `/v1/ws`。
2. Sidecar 使用 `pairToken` 连接 `/v1/ws`。
3. Relay 校验通过后，将消息按 `systemId` 在 App 与 Sidecar 间转发。

### 3.3 工具快照与详情

1. Sidecar 启动后先发：`tools_snapshot`、`tools_candidates`、`metrics_snapshot`。
2. 快照默认周期：`METRICS_INTERVAL_SEC=10`。
3. 详情默认周期：`DETAILS_INTERVAL_SEC=45`。
4. App 打开详情面板时可发送 `tool_details_refresh_request` 按需刷新。

### 3.4 聊天与报告

1. App 发送 `tool_chat_request`，Sidecar 回传 `tool_chat_started/chunk/finished`。
2. App 发送 `tool_report_fetch_request`，Sidecar 回传 `started/chunk/finished`。
3. 报告读取受限于“工作区内绝对路径 `.md` 文件”。

## 4. 运行时节奏（默认值）

1. Sidecar 心跳：`HEARTBEAT_INTERVAL_SEC=5`。
2. 快照推送：`METRICS_INTERVAL_SEC=10`。
3. 配对 Banner 刷新：`PAIRING_BANNER_REFRESH_SEC=120`。
4. 详情去抖：`DETAILS_REFRESH_DEBOUNCE_SEC=3`。
5. 详情命令超时：`DETAILS_COMMAND_TIMEOUT_MS=8000`。
6. 详情并发上限：`DETAILS_MAX_PARALLEL=2`。

## 5. 状态与存储

### 5.1 Mobile

1. `localStorage` 保存宿主机配置、UI 状态、补偿任务、结构化日志。
2. 安全存储保存设备私钥与会话凭证（Keychain / SecureStoreBridge）。
3. 聊天持久化在 Tauri `app_data/chat` 下的 `index.json + JSONL`。

### 5.2 Sidecar

1. 配置文件：`~/.config/yourconnector/sidecar/config.json`。
2. 身份文件：`~/.config/yourconnector/sidecar/system-id.txt`、`pair-token.txt`。
3. 白名单与控制端绑定由 `stores` 模块维护并持久化。

### 5.3 Relay

1. 认证存储为本地 JSON 文件（设备凭证、refresh 会话、pairToken 元数据）。
2. 运行时维护 `system room`：在线客户端、nonce 缓存、pair ticket nonce。

## 6. 代码入口

1. Relay 入口：`services/relay/src/main.rs`、`services/relay/src/app.rs`。
2. Sidecar 入口：`services/sidecar/src/main.rs`、`services/sidecar/src/session/loop/mod.rs`。
3. Mobile 入口：`app/mobile/ui/js/main.js`、`app/mobile/src-tauri/src/lib.rs`。
4. 协议定义：`protocol/rust/src/lib.rs`。
