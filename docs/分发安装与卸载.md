# yourConnector 分发安装与卸载

## 1. 目标

1. 固化 A/B 宿主机安装路径：A 机先装 Relay、再装 Sidecar；B 机只装 Sidecar。
2. 安装后以守护进程运行，通过 `yc-relay` / `yc-sidecar` 命令管理。
3. 用户输入默认只保留公网 IPv4，不要求手工拼接完整 Relay URL。

## 2. 安装脚本

1. `scripts/dist/yc-relay.sh`
2. `scripts/dist/yc-sidecar.sh`

脚本命令统一为：

1. `install`
2. `uninstall`
3. `status`
4. `doctor`
5. `start`
6. `stop`
7. `restart`

通用选项：

1. `--yes`
2. `--dry-run`
3. `--keep-data`
4. `--format text|json`（`doctor`）
5. `--asset-base <url>`（高级覆盖参数）

## 3. 用户安装命令

### 3.1 A 机：安装 Relay

```bash
sudo bash /path/to/yc-relay.sh install \
  --acme-email you@example.com \
  --public-ip <A公网IPv4>
```

### 3.2 A 机：安装 Sidecar

```bash
sudo bash /path/to/yc-sidecar.sh install \
  --relay-ip <A公网IPv4>
```

### 3.3 B 机：仅安装 Sidecar

```bash
sudo bash /path/to/yc-sidecar.sh install \
  --relay-ip <A公网IPv4>
```

## 4. 参数契约

### 4.1 `yc-relay.sh install`

1. `--acme-email <email>`：Linux 安装必填（可由 `YC_ACME_EMAIL` 兜底）。
2. `--public-ip <ipv4>`：推荐显式传入；缺失时可交互输入。
3. `--yes` 下缺失公网 IP 会失败（无历史值时退出码为 2）。
4. `--acme-staging`：可选，仅 Linux 用于 LE staging。

### 4.2 `yc-sidecar.sh install`

1. `--relay-ip <ipv4>`：推荐参数，脚本自动拼接 `wss://<ip>/v1/ws`。
2. `--relay <wss-url>`：兼容输入方式。
3. `--allow-insecure-ws`：仅调试场景允许 `ws://`。

## 5. 二进制命令口径

### 5.1 `yc-relay`

1. `yc-relay run`
2. `yc-relay status`
3. `yc-relay doctor --format text|json`
4. `yc-relay service start|stop|restart|status`
5. `yc-relay version`

### 5.2 `yc-sidecar`

1. `yc-sidecar run`
2. `yc-sidecar status`
3. `yc-sidecar doctor --format text|json`
4. `yc-sidecar service start|stop|restart|status`
5. `yc-sidecar version`
6. `yc-sidecar relay [set|-change|test|reset]`
7. `yc-sidecar pairing show --format text|json|link|qr`

## 6. 守护进程实现

### 6.1 Linux

1. Relay：systemd `yc-relay.service`。
2. Sidecar：systemd `yc-sidecar.service`。
3. Relay 证书续期：`yc-cert-renew.service` + `yc-cert-renew.timer`。

### 6.2 macOS

1. Relay：launchd `dev.yourconnector.relay`。
2. Sidecar：launchd `dev.yourconnector.sidecar`。

## 7. 地址与安全口径

1. 用户输入公网 IPv4 时，脚本统一拼接 `wss://<ip>/v1/ws`。
2. Relay Linux 默认本地监听 `127.0.0.1:18080`，公网由 nginx `443` 反代。
3. Linux 证书链路采用 Let’s Encrypt shortlived + HTTP-01 + webroot。

## 8. 卸载语义

1. 默认 `uninstall`：彻底清理服务、二进制、配置、身份、日志。
2. `uninstall --keep-data`：保留配置与身份，便于快速重装。

## 9. 发布与下载口径

### 9.1 GitHub Release 展示文件

1. `yc-relay.sh`
2. `yc-sidecar.sh`
3. `release-manifest.json`
4. `release-checksums.txt`

### 9.2 OSS 文件（按 tag）

1. `yc-relay-<os>-<arch>.tar.gz`
2. `yc-sidecar-<os>-<arch>.tar.gz`
3. `checksums.txt`

## 10. 验收重点

1. 脚本命令不包含 `run`，仅支持服务控制命令。
2. 二进制命令包含 `run` 与 `service ...`。
3. A 机两步安装、B 机一步安装可复现。
4. 卸载默认彻底清理，`--keep-data` 可复装复用。
