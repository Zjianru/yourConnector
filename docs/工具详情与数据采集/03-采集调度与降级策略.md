# yourConnector 工具详情与数据采集：采集调度与降级策略

## 1. 调度入口

会话主循环中，详情采集由两个节奏共同驱动：

1. 周期触发：`details_ticker`（默认每 45 秒）。
2. 指令触发：`tool_details_refresh_request`（可指定 `toolId` 与 `force`）。

主循环实现：`services/sidecar/src/session/loop/mod.rs`。

## 2. 去抖与合并

1. 所有详情刷新请求先合并到 `PendingDetailsRefresh`。
2. `details_dispatch_ticker` 按去抖窗口派发真实采集任务。
3. 去抖窗口默认 `3` 秒，避免重复点开弹窗导致风暴采集。

## 3. 缓存与 TTL

1. 详情缓存按 `toolId` 存储。
2. 默认 `expiresAt = now + details_interval * 2`。
3. 采集成功：更新 `schema/data/collectedAt/expiresAt/stale=false`。
4. 采集失败：保留旧 `data`，写入 `collectError`，标记 `stale=true`。

实现：`services/sidecar/src/tooling/core/cache.rs`。

## 4. 快照分层

Sidecar 每次快照会并行发送：

1. `tools_snapshot`：已接入工具。
2. `tools_candidates`：候选工具。
3. `metrics_snapshot`：系统与工具指标。

规则：白名单中已接入工具即使进程暂时不可见，也会生成离线占位条目，避免 UI 卡片闪断。

实现：`services/sidecar/src/session/snapshots.rs`。

## 5. 前端详情刷新策略

1. 打开工具详情弹窗时，App 会发送 `tool_details_refresh_request` 且 `force=true`。
2. 详情下行按 `runtimeToolId` 对齐，落在 `runtime.toolDetailsById`。
3. 渲染层基于 `schema` 分发（OpenClaw 专属页 / 默认卡片页）。

对应代码：

1. `app/mobile/ui/js/modals/tool-detail.js`
2. `app/mobile/ui/js/flows/connection-events.js`
3. `app/mobile/ui/js/state/runtime.js`

## 6. 验收清单（详情域）

1. 连接成功后可收到 `tool_details_snapshot`。
2. 打开详情弹窗可触发按需刷新。
3. 采集失败时显示 stale 提示，不丢失最近成功数据。
4. OpenClaw 渲染为五屏，OpenCode 渲染为默认详情卡片。
5. 详情缓存在工具断开后可随工具集变化正确清理。
