# yourConnector 系统日志与归档 v1

## 1. 文档目标

定义 relay 与 sidecar 的系统日志落盘、按天归档和运维检查口径，作为后续聊天页日志能力的基础设施文档。

## 2. 适用范围

1. `/Users/codez/develop/yourConnector/services/relay`
2. `/Users/codez/develop/yourConnector/services/sidecar`
3. `/Users/codez/develop/yourConnector/app/mobile/ui/js`（结构化操作日志）

移动端当前输出结构化操作日志到内存态调试面板，不进入服务端 `.7z` 归档。

## 3. 目录与命名约定

1. 日志根目录：`/Users/codez/develop/yourConnector/logs`（可通过环境变量改写）
2. 原始日志目录：`/Users/codez/develop/yourConnector/logs/raw`
3. 归档目录：`/Users/codez/develop/yourConnector/logs/archive`
4. 原始文件命名：`<service>.log.YYYY-MM-DD`
5. 归档文件命名：`YYYY-MM-DD.7z`

示例：

1. `relay.log.2026-02-23`
2. `sidecar.log.2026-02-23`
3. `2026-02-22.7z`

## 4. 运行机制

1. 服务启动时初始化双通道日志：
   - stdout（便于开发调试）
   - 文件（系统性落盘）
2. 服务启动时立即扫描 `raw` 目录，把“早于今天”的日志按天归档为 `.7z`。
3. 服务运行期间按固定周期执行归档任务（默认每 3600 秒一次）。
4. 归档成功后删除对应 `raw` 原文件。
5. 多进程并发归档通过目录锁（`.archive-lock`）互斥，避免重复打包或并发冲突。
6. 协议事件默认附带 `traceId`，relay/sidecar 记录链路摘要时会输出 `trace_id`。

## 5. 环境变量

1. `YC_LOG_DIR`
   - 作用：日志根目录
   - 默认值：`logs`
2. `YC_LOG_ARCHIVE_INTERVAL_SEC`
   - 作用：归档任务轮询周期（秒）
   - 默认值：`3600`
3. `YC_FILE_LOG_LEVEL`
   - 作用：文件日志级别
   - 默认值：`info`
4. `RUST_LOG`
   - 作用：stdout 日志过滤
   - 说明：不再影响文件日志级别

## 6. 安全边界

1. 本阶段仅记录系统运行态日志，不落业务正文消息体。
2. 归档仅处理 `logs/raw` 的系统日志文件。
3. 后续聊天页日志扩展必须遵守“不记录敏感凭证”的治理原则。

## 7. traceId 与结构化日志

1. 协议字段：
   - `eventId`：单事件唯一标识。
   - `traceId`：同一用户操作链路追踪标识（跨 mobile/relay/sidecar）。
2. mobile 侧：
   - 每次操作会写入 `state.operationLogs`，并在调试页展示汇总。
   - 配置持久化时会保留最近结构化日志快照（最多 500 条）便于重启后排障。
   - 调试页支持“复制结构化日志”，可直接导出 JSON。
3. relay/sidecar 侧：
   - 文件日志会记录 `type/event_id/trace_id/tool_id` 摘要。
   - 命令回执沿用请求 `traceId`，便于追踪“发起 -> 回执”闭环。

## 8. 验证步骤

```bash
cd /Users/codez/develop/yourConnector
make run-relay
make run-sidecar
```

另开终端检查：

```bash
cd /Users/codez/develop/yourConnector
ls -la logs/raw
tail -n 20 logs/raw/relay.log.$(date +%Y-%m-%d)
tail -n 20 logs/raw/sidecar.log.$(date +%Y-%m-%d)
```

归档验证（可用前一天文件做演练）：

```bash
cd /Users/codez/develop/yourConnector
ls -la logs/archive
```

traceId 验证（检查 relay 日志）：

```bash
cd /Users/codez/develop/yourConnector
tail -n 100 logs/raw/relay.log.$(date +%Y-%m-%d) | rg "trace_id"
```
