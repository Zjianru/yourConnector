# yourConnector 开发与调试指南

## 1. 目标

1. 提供可直接执行的本地开发流程。
2. 提供常用联调与排障路径。
3. 约束变更后的最小自检动作。

## 2. 本地启动流程

### 2.1 启动后端服务

```bash
make run-relay
make run-sidecar
```

健康检查：

```bash
curl -sS http://127.0.0.1:18080/healthz
curl -sS http://127.0.0.1:18081/healthz
```

### 2.2 启动移动端

iOS：

```bash
make run-mobile-tauri-ios IOS_SIM="iPhone 17 Pro"
```

Android：

```bash
make init-mobile-tauri-android
make run-mobile-tauri-android-dev ANDROID_DEVICE="<device>"
```

## 3. 配对与连接调试

1. 查看配对信息：`make show-pairing`。
2. 只取深链：`make show-pairing-link`。
3. iOS 模拟扫码：`make simulate-ios-scan`。
4. Android 模拟扫码：`make simulate-android-scan ANDROID_DEVICE="emulator-5554"`。
5. 若 App 提示 `PAIR_TOKEN_NOT_SUPPORTED`，说明使用了旧链路，应改为 `sid + ticket`。

## 4. 常见联调点

### 4.1 工具接入与详情

1. 连接后应收到 `tools_snapshot`、`tools_candidates`、`metrics_snapshot`。
2. 打开详情应触发 `tool_details_refresh_request`。
3. Sidecar 应回传 `tool_details_snapshot`。

### 4.2 聊天

1. App 发 `tool_chat_request`。
2. Sidecar 回 `tool_chat_started/chunk/finished`。
3. 单会话仅允许一个运行中请求，冲突时返回 `busy`。

### 4.3 报告

1. App 发 `tool_report_fetch_request`。
2. Sidecar 回 `tool_report_fetch_started/chunk/finished`。
3. 路径必须是“工作区内绝对 `.md` 文件”，否则失败。

## 5. 日志排障

### 5.1 服务日志

1. 目录：`logs/raw`。
2. 归档：`logs/archive/YYYY-MM-DD.7z`。
3. 查看最新日志：

```bash
tail -n 200 logs/raw/relay.log.$(date +%Y-%m-%d)
tail -n 200 logs/raw/sidecar.log.$(date +%Y-%m-%d)
```

### 5.2 移动端日志

1. 页面调试区同时维护文本日志与结构化日志。
2. 可复制结构化日志 JSON 用于复盘。
3. `rawPayload` 调试可通过 URL 参数或本地开关启用。

## 6. 一键自检与门禁

1. 语法/编译/测试/治理全量检查：`make check-all`。
2. 仅治理门禁：`make check-governance`。
3. 自动调试闭环：`make self-debug-loop`。

## 7. 提交流程建议

1. 先执行 `make check-governance`，确认注释与文档一致性通过。
2. 再执行 `make check-all`，确认无编译或测试回归。
3. 若协议、CLI、部署参数有改动，必须同步回改对应文档。
