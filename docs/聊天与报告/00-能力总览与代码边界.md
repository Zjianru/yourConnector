# yourConnector 聊天与报告：能力总览与代码边界

## 1. 文档目标

1. 定义聊天页与报告查看能力的实现边界。
2. 以代码事实描述会话模型、请求模型、持久化模型。
3. 为后续聊天协议扩展提供兼容基线。

## 2. 能力范围

当前版本聊天域包含：

1. 会话列表/会话详情/完整消息三态切换。
2. 单会话消息队列、串行执行、取消运行中请求。
3. `tool_chat_*` 事件的流式聚合与状态收敛。
4. 报告路径点击触发 `tool_report_fetch_*` 拉取。
5. 报告 Markdown 弹窗渲染、进度展示、错误提示。
6. 会话本地持久化（索引 + JSONL 事件快照）。

## 3. 关键代码边界

移动端：

1. `app/mobile/ui/js/state/chat.js`
2. `app/mobile/ui/js/flows/chat.js`
3. `app/mobile/ui/js/views/chat.js`
4. `app/mobile/ui/js/modals/report-viewer.js`
5. `app/mobile/ui/js/utils/markdown.js`
6. `app/mobile/src-tauri/src/lib.rs`（`chat_store_*`）

服务端：

1. `services/sidecar/src/session/loop/chat.rs`
2. `services/sidecar/src/session/loop/report.rs`
3. `services/sidecar/src/session/loop/command.rs`
4. `services/sidecar/src/control.rs`

## 4. 关键设计约束

1. 会话键为 `hostId::toolId`，用于跨页面与持久化统一索引。
2. 每个会话同一时刻只允许 1 个运行中聊天任务。
3. 聊天队列上限固定为 `20`（`CHAT_QUEUE_LIMIT`）。
4. 报告只允许读取“工具工作区内绝对路径 `.md` 文件”。
5. 报告文件必须是有效 UTF-8，按 `16KB` 分片发送。
