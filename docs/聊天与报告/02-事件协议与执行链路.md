# yourConnector 聊天与报告：事件协议与执行链路

## 1. 聊天事件协议

### 1.1 App -> Sidecar

1. `tool_chat_request`
2. `tool_chat_cancel_request`

### 1.2 Sidecar -> App

1. `tool_chat_started`
2. `tool_chat_chunk`
3. `tool_chat_finished`

字段重点：`toolId` `conversationKey` `requestId` `queueItemId`。

## 2. 聊天执行链路（代码事实）

1. App 发送 `tool_chat_request` 后，Sidecar 先发 `started`。
2. 执行中流式返回 `chunk`，最终返回 `finished`。
3. 同会话并发请求会被 Sidecar 拒绝为 `status=busy`。
4. 取消请求命中时返回 `status=cancelled`。
5. 工具不在线或未接入时返回 `status=failed`。

实现文件：

1. `services/sidecar/src/session/loop/command.rs`
2. `services/sidecar/src/session/loop/chat.rs`

## 3. 报告事件协议

### 3.1 App -> Sidecar

1. `tool_report_fetch_request`

### 3.2 Sidecar -> App

1. `tool_report_fetch_started`
2. `tool_report_fetch_chunk`
3. `tool_report_fetch_finished`

字段重点：`filePath` `bytesSent` `bytesTotal` `chunkIndex`。

## 4. 报告执行链路（代码事实）

1. Sidecar 校验路径必须为绝对路径且扩展名为 `.md`。
2. 目标文件必须位于工具 `workspaceDir` 的 canonical 路径内。
3. 文件按 `16 * 1024` 字节分片，按 UTF-8 边界输出 chunk。
4. 会话内并发报告请求会返回 `status=busy`。
5. 取消或路径校验失败都会返回 `status=failed` 并带 `reason`。

实现文件：

1. `services/sidecar/src/session/loop/report.rs`
2. `services/sidecar/src/session/loop/command.rs`

## 5. App 侧状态收敛

1. `started`：标记 `running`，创建/更新 assistant 流式消息。
2. `chunk`：追加正文并保持 `streaming`。
3. `finished`：清理 `running`，更新 user/assistant 消息终态。
4. `report_*`：通过 `reportTransfersByRequestId` 聚合，驱动弹窗状态。

实现文件：`app/mobile/ui/js/flows/chat.js`。
