# yourConnector 聊天与报告：页面交互与会话模型

## 1. 页面状态

聊天页 `viewMode` 有三种：

1. `list`：会话列表。
2. `detail`：会话消息流与输入框。
3. `message`：单条消息完整视图（支持缩放）。

对应代码：`app/mobile/ui/js/state/chat.js` `app/mobile/ui/js/flows/chat.js`。

## 2. 会话数据模型

会话核心字段（`conversationsByKey[key]`）：

1. 宿主与工具：`hostId` `toolId` `runtimeToolId` `toolClass`。
2. 显示信息：`hostName` `toolName` `availability` `online`。
3. 消息流：`messages[]`。
4. 队列：`queue[]` + `running`。
5. 输入态：`draft`。
6. 错误态：`error`。

## 3. 消息与队列行为

1. 发送前先入队并写入一条 `role=user status=queued` 消息。
2. 仅当会话在线且非 `invalid` 才允许发起请求。
3. `running` 存在时显示“停止生成”按钮。
4. 队列可展开/收起，可删除待发送项。
5. 可进入消息选择模式批量删除已完成消息。

对应代码：`app/mobile/ui/js/flows/chat.js` `app/mobile/ui/js/views/chat.js`。

## 4. 报告查看交互

1. 点击消息中的报告路径触发拉取。
2. 弹窗展示路径、进度条、错误信息、Markdown 正文。
3. 拉取中根据 `bytesSent/bytesTotal` 显示百分比。
4. 失败时保留错误文本，不渲染空白成功态。

对应代码：`app/mobile/ui/js/modals/report-viewer.js` `app/mobile/ui/js/flows/chat.js`。

## 5. 本地持久化

### 5.1 存储结构

1. 索引：`<appData>/chat/index.json`
2. 会话事件：`<appData>/chat/conversations/conv_<hash>.jsonl`

### 5.2 原生命令

1. `chat_store_bootstrap`
2. `chat_store_append_events`
3. `chat_store_load_conversation`
4. `chat_store_upsert_index`
5. `chat_store_delete_conversation`

实现文件：`app/mobile/src-tauri/src/lib.rs`。
