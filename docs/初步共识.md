# Sidecar IM：产品方向与架构共识（v0）

> 目标：做一个“像微信一样”的移动端 IM 外壳，用来远程指挥本地/远端机器上的 AI 工具（统一称为 sidecar），并以聊天与状态页两种入口完成控制、观测、调试与归档分享。

---

## 1. 核心判断与共识

- **可行性**：这是一个成熟问题的重新组合：IM（会话/消息）+ 附件（语音/文件）+ 远端执行（CLI/HTTP/SDK）+ 可观测（状态/日志/任务）+ 权限控制。
- **价值主张**：
  - 手机端承担 **指挥、授权、查看、归档**；算力与执行留在远端机器/本地端 sidecar。
  - 让“工具端”和“人端”统一成一种会话对象：用户用同一个入口与 AI 工具/真人对话、分享记录。
- **不绑定 openclaw**：
  - openclaw 只是阶段性现象；未来 AI 助手载体会更多。
  - 重点是 **sidecar 抽象** 与 **角色分类**，而不是某个具体工具品牌。

---

## 2. 命名与抽象

### 2.1 Sidecar（统一称呼）
将所有 openclaw / opencode / codex / claude code 等“运行在远端机器、希望手机远程使用”的 AI 工具载体统一称为 **sidecar**。

Sidecar 是一个远端工作体，至少包含：
- **Transport**：与手机/relay 的连接（消息、附件、心跳）
- **Runner**：把用户输入交给具体工具执行（CLI/HTTP/SDK）
- **Capture**：忠实采集并回传输出（stdout/stderr/事件/产物）
- **Policy**：权限、命令白名单、资源限制、审计

> 关键原则：**忠实转交用户输入、完整复原工具输出**。MVP 不做复杂“转义/重写”。

### 2.2 角色分类（Taxonomy）
使用“角色”分类而非“产品名”，便于未来扩展。

- **助手类（Assistant）**  
  以对话/任务/资料整理/工具链编排为主（例如 openclaw-like）。
- **开发员工类（Dev Worker）**  
  以工程上下文里的持续开发工作为主（例如 opencode / codex / claude code）。
  输出特征：长日志、diff、patch、测试结果、命令回显。

（可扩展）
- Ops Worker：运维/部署/监控/脚本
- Data Worker：SQL/ETL/报表
- Creative Worker：素材/文案/脚本

---

## 3. 产品形态：状态页 + 聊天页的双入口

### 3.1 状态页（Dashboard）
状态页负责“看与管”，提供全局可观测与运维快捷操作。

**第一屏核心卡片：**
- 连接状态：在线/离线、最后心跳、延迟
- 版本与更新：sidecar/工具/agent 版本、可用更新
- 资源：CPU/内存/磁盘/GPU（如有）
- 任务队列：running/queued/failed
- 最近错误：最近 N 条错误（可点击跳转调试）

**快捷按钮（管理命令）：**
- 重启 sidecar
- 重启工具/服务
- 拉取更新/升级
- 重载配置
- 导出诊断包（logs + 配置摘要）

> 按钮不直接执行任意 shell：必须走 **受控命令集（allowlist）**，并配合权限/确认。

### 3.2 聊天页（Geek Debug Console）
聊天页负责“问与调”，本质上是给系统发消息：
- 获取最新状态
- 深层调试（抓日志、网络诊断、解释报错）
- 任务执行与结果回传

建议三层交互：
1. 普通对话（自然语言）
2. 快捷指令（chips / slash commands）：一键发结构化 command
3. 深度调试（结构化卡片 + 可展开日志/分页）

> LLM = 解释器/分析员；sidecar = 事实采集与执行器。

---

## 4. 会话与对象：System → 分组 → 聊天对象

### 4.1 顶层对象（System）
每个 sidecar 部署/实例（例如 home-pc、workstation、nas）是一个 System：
- 有自己的状态页
- 有系统级聊天入口（System Chat，可选）

### 4.2 工具分组（Tool Group）
在一个 System 内，将会话按角色/体系进行分组，聊天列表 **默认折叠**：
- 助手类（Assistant）
- 开发员工类（Dev Worker）
- …（未来扩展）

分组行展示：
- 分组名、agent 数、未读数、聚合运行状态（绿/黄/红）

### 4.3 聊天对象（Chat Peer）
- **Agent**：工具内部 agent，属于某个分组（折叠显示）
- **Human**：真人用户（默认不折叠、强标识）

**Agent 会话建议固定头部：**
- 角色说明（职责/可做什么）
- 常用模板按钮（任务快捷入口）
- 上下文范围（未来用于 workspace/权限说明）

---

## 5. 真人会话：强标识 + 防误操作

- 真人会话默认不折叠，并且具有更鲜明标识（头像/颜色/标签）。
- 安全建议：
  - 真人会话中默认 **禁止**触发本地执行类命令；或必须二次确认。
  - 导出/分享时默认脱敏：隐藏本地路径、token、敏感日志字段。

---

## 6. “忠实复原输出”的工程注意点

针对 CLI 型工具（opencode/codex/claude code），MVP 只需做到：
- 输入 → 远端执行 → 捕获 stdout/stderr → 原样回传

但需提前考虑显示策略：
- 许多 CLI 含 ANSI color、光标控制、进度条（\\r 覆盖行）
- 建议双视图：
  - **Raw View**：纯 transcript，最小处理，确保不乱
  - **ANSI View（可选）**：更像真终端

同时支持在同一份输出上做“旁路结构化”：
- **Smart View（可读卡片）**：diff/测试摘要/错误定位/产物链接
- 与 Raw View 可切换，底层数据同源

---

## 7. 事件化协议（建议从 v0 就采用）

不把系统做成“只有文本聊天”，而是统一用事件模型贯穿状态页与聊天页。

**最小事件集合（v0）：**
- `heartbeat`：sidecar → phone（在线与延迟）
- `metrics_snapshot`：资源与关键指标快照
- `command_request`：phone → sidecar（按钮/chips/聊天触发）
- `command_result`：sidecar → phone（结构化结果卡片）
- `chat_message`：文本/语音/文件（人/agent/system）
- `task_request / task_status / task_result`：任务与进度

**附件（Attachment）独立对象：**
- 语音/文件均为附件 + 元信息
- 消息里引用 `attachmentId`，不直接塞大内容
- 后续可扩展：分片/断点续传/哈希校验

**可靠性（最小保证）：**
- messageId + ack 防重复
- seq/chunk 保证输出顺序
- 断线重连补发（至少可做到“尽量不丢”）

---

## 8. MVP 范围与非目标

### 8.1 MVP 必做
1. System 列表 + 在线状态
2. System 状态页（心跳/版本/资源/最近错误）
3. System 聊天（支持获取状态/抓日志 chips，返回卡片）
4. 分组折叠（Assistant / Dev Worker）+ agent 会话
5. 文本 + 文件 + 语音（语音视为附件）
6. 会话归档与分享（导出 md/pdf + 会话包，默认脱敏）

### 8.2 MVP 可暂缓
- 浏览电脑文件夹 / workspace 选择（可不纳入 MVP）
- 复杂权限系统（先做命令白名单 + 二次确认）
- Push 通知（可留接口，后续接 APNs/FCM）
- 高级图表与长周期监控（先做快照与最近错误）

---

## 9. 方向总结

- 用 **IM 作为统一入口**：对话 + 指令 + 调试 + 归档分享。
- 用 **状态页作为管理入口**：可观测 + 运维快捷操作。
- 用 **sidecar 抽象与角色分类** 规避对单一工具的绑定，接入更多 AI 助手/开发员工载体成本最低。
- 对 CLI 型开发员工工具：先做到 **原样转交输入输出**，再逐步叠加结构化视图与高级能力。

---