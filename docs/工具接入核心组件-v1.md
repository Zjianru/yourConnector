# yourConnector 工具接入核心组件 v1

## 1. 文档目标

1. 固化 `OpenClaw + OpenCode` 的统一接入框架（Tool Adapter Core）。
2. 明确 OpenClaw 的“摘要/详情分层”数据模型与移动端展示边界。
3. 作为后续新增第三方工具 Adapter 的实现基线。

## 2. 设计边界

1. 只采集非敏感运行态，不采集业务正文与认证密钥。
2. 详情缓存仅内存态，不落库。
3. 不改现有配对与鉴权主链路（App 继续 `accessToken + PoP`，sidecar 继续 `pairToken`）。
4. Usage 统计仅依赖 OpenClaw 官方 CLI 与 `openclaw.json`，不读取 `custom/state` 自定义统计文件。

## 3. Sidecar 核心结构

1. 核心调度：`services/sidecar/src/tooling/core/mod.rs`
2. 缓存与 stale：`services/sidecar/src/tooling/core/cache.rs`
3. 调度参数：`services/sidecar/src/tooling/core/scheduler.rs`
4. 适配器注册：`services/sidecar/src/tooling/adapters/mod.rs`
5. OpenClaw 适配器：`services/sidecar/src/tooling/adapters/openclaw.rs`
6. OpenCode 适配器：`services/sidecar/src/tooling/adapters/opencode.rs`

## 4. 采集与刷新策略（当前实现）

1. 快周期（默认 5s）：进程发现并更新 `tools_snapshot/metrics_snapshot`。
2. 慢周期（默认 45s）：周期触发 `tool_details_snapshot` 详情补采。
3. 按需刷新：移动端打开工具详情时发送 `tool_details_refresh_request` 并强制刷新目标工具。
4. 去抖窗口：默认 3s，避免重复打开详情导致 CLI 风暴。
5. 并发上限：默认 2（按 profile 并发采集）。
6. OpenClaw 命令超时（命令级上限）：
   - `status --json --usage`：8000ms
   - `health --json`：6000ms
   - `channels status --json`：5000ms
   - `gateway status --json`：8000ms
   - `memory/security`：6000ms
   - `agents/sessions`：2500ms
7. `health --json` 与 `gateway status --json` 固定纳入慢层采集（不再仅限深采），用于健康摘要与 RPC 连通性展示。

## 5. 详情事件协议

1. sidecar -> app：`tool_details_snapshot`
2. app -> sidecar：`tool_details_refresh_request`
3. 协议类型定义：`protocol/rust/src/lib.rs`
4. 公共 Envelope 字段：
   - `toolId`
   - `schema`（`openclaw.v1` / `opencode.v1`）
   - `stale`
   - `collectedAt`
   - `expiresAt`
   - `profileKey`
   - `data`

## 6. OpenClaw 详情模型（`openclaw.v1`）

`openclaw.v1.data` 按分区组织（全部可选，向后兼容）：

1. `overview`
   - `defaultAgentId/defaultAgentName`
   - `totalAgents/activeSessions24h/abortedSessions`
   - `channelIdentities[]`（`Channel@Account` 身份，支持 `username/accountDisplay`）
   - `usageHeadline`（混合口径头条）
   - `dashboardMeta`（仅状态信息，不含跳转）
   - `gatewayServiceStatus/nodeServiceStatus`
2. `agents[]`
   - `agentId/name/model/workspaceDir/isDefault`
   - `sessionsCount/isDefault`
   - `heartbeatEnabled/heartbeatEveryMs`
   - `bindings/routes`
   - `contextUsedTokens/contextMaxTokens/contextLimitSource`
3. `sessions`
   - `diagnostics`（aborted/system/stale/active/inactive 分布，含 `abortedRate24h/systemRatio`）
   - `timeline[]`（时间线视角，含 `updatedAgoSec`）
   - `ledger[]`（台账视角，含 `healthTag`）
4. `usage`
   - `authWindows[]`（账号窗口真实值，含“已使用占比”语义与 auth 用户名）
   - `apiProviderCards[]`（API 来源按 provider 聚合）
   - `modelsWithCost[]`（1h 内有 token 活动的模型）
   - `modelsWithoutCost[]`（1h 内无 token 活动的模型）
   - `configuredModels[]`（配置中的全模型清单）
   - `modelTotals[]`（兼容旧字段）
   - `estimatedCost[]`（兼容旧字段）
   - `coverage`（覆盖说明）
5. `systemService`
   - `memoryIndex[]`
   - `securitySummary`（`critical/warn/info`）
   - `securityFindings[]`（精简明细）
   - `gatewayRuntime`
   - `healthSummary`（含 `lastCheckedAt`）
6. `statusDots`
   - `gateway`（`online/offline/unknown`）
   - `data`（`fresh/stale/unknown`）

映射规则：

1. 优先按 `workspaceDir` 匹配 `agents/sessions`。
2. 匹配失败回退同 profile 聚合结果，不清空旧值。
3. 同宿主机多实例不去重，保持实例级 `toolId`。

## 7. OpenCode 详情模型（`opencode.v1`）

1. `workspaceDir`
2. `sessionId/sessionTitle/sessionUpdatedAt`
3. `agentMode/providerId/modelId/model`
4. `latestTokens`
5. `modelUsage`

## 8. 降级与故障处理

1. CLI 不可用、超时或 JSON 解析失败时：
   - 保留最近成功数据
   - 标记 `stale=true`
   - 在 `data.collectError` 写入短错误描述
   - `statusDots.data` 标记为 `stale`
2. 详情采集失败不影响工具在线判定，避免将“详情故障”误判为“工具离线”。
3. 默认日志只输出摘要，不输出完整业务 JSON。

## 9. Mobile 渲染约定

1. 运行态缓存：
   - `runtime.toolDetailsById`
   - `runtime.toolDetailStaleById`
   - `runtime.toolDetailUpdatedAtById`
2. 详情页打开即触发按需刷新（目标工具 + force）。
3. OpenClaw 摘要卡只显示关键安心字段：
   - 渠道身份（`Channel@username` 优先，回退 `Channel@accountId`）
   - 默认 Agent
   - 会话诊断（24h 活跃 + 异常）
   - 混合用量头条（账号窗口优先，缺失回退本地估算）
   - 网关/数据状态点
4. OpenClaw 详情页按固定多屏顺序渲染：
   - 概览
   - Agents
   - Sessions
   - Usage
   - 系统与服务
5. Sessions 页采用“诊断/时间线/台账”同页分段，不再使用二级横滑。
   - 诊断默认展示 4 个核心指标：24h 活跃 / aborted 占比 / system 占比 / 长时间未更新。
   - 时间线与台账统一展示 `K` 口径 token。
6. Agents 页采用纵向展开（Accordion），路径字段强制换行并使用等宽字体。
7. OpenCode 详情页继续使用摘要 + 展开的结构，不与 OpenClaw 共用正文模板。
8. 详情页采用紧凑布局：顶部到首卡间距收敛，空数据时展示“正在采集中”占位，不留大块空白。

## 10. 调试与验收入口

1. 全量门禁：`make check-all`
2. Sidecar 详情链路关键文件：
   - `services/sidecar/src/session/loop/mod.rs`
   - `services/sidecar/src/session/snapshots.rs`
   - `services/sidecar/src/control.rs`
3. 移动端详情渲染关键文件：
   - `app/mobile/ui/js/flows/connection-events.js`
   - `app/mobile/ui/js/views/tools.js`
   - `app/mobile/ui/js/modals/tool-detail.js`
