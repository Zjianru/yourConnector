# yourConnector 系统日志与归档

## 1. 文档目标

定义 Relay 与 Sidecar 的日志落盘、按天归档和排障口径，保障跨端追踪可复现。

## 2. 适用范围

1. `services/relay`
2. `services/sidecar`
3. `app/mobile/ui/js`（结构化操作日志）

说明：移动端结构化日志当前为内存态展示与导出，不写入服务端 `.7z` 归档。

## 3. 目录与命名约定

1. 日志根目录：`logs`（可通过环境变量改写）。
2. 原始日志目录：`logs/raw`。
3. 归档目录：`logs/archive`。
4. 原始文件命名：`<service>.log.YYYY-MM-DD`。
5. 归档文件命名：`YYYY-MM-DD.7z`。

示例：

1. `logs/raw/relay.log.2026-02-26`
2. `logs/raw/sidecar.log.2026-02-26`
3. `logs/archive/2026-02-25.7z`

## 4. 运行机制

1. 服务启动时初始化双通道日志：
   - stdout：面向联调的摘要输出。
   - 文件日志：面向排障与归档的持久化输出。
2. 启动时立即扫描 `logs/raw`，将“早于今天”的日志按天归档。
3. 运行期间按固定周期执行归档任务（默认每 3600 秒）。
4. 归档成功后删除对应 `raw` 历史文件。
5. 归档过程使用目录锁（`.archive-lock`）避免并发冲突。

## 5. 环境变量

1. `YC_LOG_DIR`：日志根目录，默认 `logs`。
2. `YC_LOG_ARCHIVE_INTERVAL_SEC`：归档轮询周期（秒），默认 `3600`。
3. `YC_FILE_LOG_LEVEL`：文件日志级别，默认 `debug`。
4. `RUST_LOG`：stdout 过滤，不影响文件日志级别。
5. `YC_DEBUG_RAW_PAYLOAD`：Sidecar 是否输出原始消息体（默认关闭）。

## 6. 追踪字段口径

1. `eventId`：单事件唯一标识。
2. `traceId`：同一用户操作的跨端追踪标识。
3. `eventType`：事件类型。
4. `hostId/toolId`：宿主机与工具维度定位字段。

Relay/Sidecar 文件日志应至少保留 `type/event_id/trace_id/tool_id` 摘要。

## 7. 安全边界

1. 默认不记录业务正文消息体。
2. 默认不记录认证密钥与凭证原文。
3. 若临时打开原始 payload 日志，问题定位后必须关闭。

## 8. 验证步骤

```bash
cd yourConnector
make run-relay
make run-sidecar
ls -la logs/raw
ls -la logs/archive
```

检查追踪字段：

```bash
tail -n 200 logs/raw/relay.log.$(date +%Y-%m-%d) | rg "event_id|trace_id"
tail -n 200 logs/raw/sidecar.log.$(date +%Y-%m-%d) | rg "event_id|trace_id"
```
