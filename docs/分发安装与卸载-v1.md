# yourConnector 分发安装与卸载 v1

## 1. 目标

1. 固化 A/B 宿主机安装路径：A 机先装 relay、再装 sidecar；B 机只装 sidecar。
2. 安装后以守护进程运行，通过 `yc-relay` / `yc-sidecar` 命令管理。
3. 用户输入只保留公网 IPv4，不要求手工输入完整 relay URL。

## 2. 安装脚本

1. `scripts/dist/yc-relay.sh`
2. `scripts/dist/yc-sidecar.sh`

脚本命令统一为：

1. `install`
2. `uninstall`
3. `status`
4. `doctor`
5. `start`
6. `stop`
7. `restart`

通用选项：

1. `--yes`
2. `--dry-run`
3. `--keep-data`
4. `--format text|json`（仅 `doctor`）
5. `--asset-base <url>`（高级覆盖参数，默认使用脚本内置地址）

## 3. 用户安装命令

### 3.1 A 机：先装 relay

```bash
sudo bash /path/to/yc-relay.sh install \
  --acme-email you@example.com \
  --public-ip <A公网IPv4>
```

### 3.2 A 机：再装 sidecar

```bash
sudo bash /path/to/yc-sidecar.sh install \
  --relay-ip <A公网IPv4>
```

### 3.3 B 机：只装 sidecar

```bash
sudo bash /path/to/yc-sidecar.sh install \
  --relay-ip <A公网IPv4>
```

## 4. 参数契约

### 4.1 `yc-relay.sh install`

1. `--acme-email <email>`：Linux 安装必填（可由 `YC_ACME_EMAIL` 兜底）。
2. `--public-ip <ipv4>`：推荐显式传入；未传时会交互输入（`--yes` 下必须提供或复用历史值）。
3. `--acme-staging`：可选，仅 Linux 用于 LE staging。

### 4.2 `yc-sidecar.sh install`

1. `--relay-ip <ipv4>`：推荐参数，脚本自动拼 `wss://<ip>/v1/ws`。
2. `--relay <wss-url>`：兼容参数。

## 5. 二进制命令口径

### 5.1 `yc-relay`

1. `yc-relay run`
2. `yc-relay status`
3. `yc-relay doctor --format text|json`
4. `yc-relay service start|stop|restart|status`
5. `yc-relay version`

### 5.2 `yc-sidecar`

1. `yc-sidecar run`
2. `yc-sidecar status`
3. `yc-sidecar doctor --format text|json`
4. `yc-sidecar service start|stop|restart|status`
5. `yc-sidecar version`
6. `yc-sidecar relay ...`
7. `yc-sidecar pairing show --format text|json|link|qr`

## 6. 守护进程实现

### 6.1 Linux

1. relay：systemd `yc-relay.service`
2. sidecar：systemd `yc-sidecar.service`
3. relay 证书续期：`yc-cert-renew.service` + `yc-cert-renew.timer`

### 6.2 macOS

1. relay：launchd `dev.yourconnector.relay`
2. sidecar：launchd `dev.yourconnector.sidecar`

## 7. 地址与安全口径

1. 用户只输入公网 IPv4。
2. 脚本内统一拼接 relay 地址：`wss://<ip>/v1/ws`。
3. Linux relay 默认 `127.0.0.1:18080` 本地监听，公网通过 nginx `443` 反代。
4. Linux relay 证书链路固定：Let’s Encrypt shortlived + HTTP-01 + webroot。

## 8. 卸载语义

1. 默认 `uninstall`：彻底清理服务、二进制、配置、身份、日志。
2. `uninstall --keep-data`：保留配置与身份，便于快速重装。

## 9. 发布与下载

### 9.1 GitHub Release 展示文件

1. `yc-relay.sh`
2. `yc-sidecar.sh`
3. `release-manifest.json`
4. `release-checksums.txt`

### 9.2 OSS 文件（按 tag）

1. `yc-relay-linux-amd64.tar.gz`
2. `yc-relay-linux-arm64.tar.gz`
3. `yc-relay-macos-amd64.tar.gz`
4. `yc-relay-macos-arm64.tar.gz`
5. `yc-sidecar-linux-amd64.tar.gz`
6. `yc-sidecar-linux-arm64.tar.gz`
7. `yc-sidecar-macos-amd64.tar.gz`
8. `yc-sidecar-macos-arm64.tar.gz`
9. `checksums.txt`

## 10. 验收重点

1. 脚本命令不包含 `run`，仅支持服务控制命令。
2. 二进制命令包含 `run` 与 `service ...`。
3. A 机两步安装成功，B 机一步安装成功。
4. 卸载默认彻底清理，`--keep-data` 可复装复用。
5. Release 页面不展示 tar.gz，OSS 存在完整二进制矩阵。
