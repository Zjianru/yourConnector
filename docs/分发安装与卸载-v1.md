# yourConnector 分发安装与卸载 v1

## 1. 文档目标

1. 固化 Linux 首发分发方案：`relay-sidecar.sh`（网关+执行机）与 `sidecar.sh`（执行机）。
2. 明确参数、目录、systemd、证书续期、卸载与 `doctor/status` 语义，避免实现分叉。
3. 保证默认公网仅 `WSS`，`WS` 只在调试显式开启。

## 2. 适用范围

1. 系统：Ubuntu / Debian（v1）。
2. 网络：需要稳定公网 IPv4（无域名）。
3. 权限：安装与卸载需要 `sudo/root`。

## 3. 脚本入口

### 3.1 网关+执行机

脚本：`scripts/dist/relay-sidecar.sh`

支持命令：

1. `install`
2. `uninstall`
3. `status`
4. `doctor`
5. `start`
6. `stop`
7. `restart`

### 3.2 执行机

脚本：`scripts/dist/sidecar.sh`

支持命令：

1. `install`
2. `uninstall`
3. `status`
4. `doctor`
5. `start`
6. `stop`
7. `restart`

## 4. 参数契约

### 4.1 `relay-sidecar.sh`

1. `--version <tag>`：安装必填。
2. `--acme-email <email>`：安装必填；可由 `YC_ACME_EMAIL` 兜底。
3. `--public-ip <ipv4>`：可选，优先级最高。
4. `--acme-staging`：可选，启用 LE staging。
5. `--dry-run`：可选。
6. `--yes`：可选，跳过确认。
7. `--purge`：可选，仅用于 `uninstall`。
8. `--format <text|json>`：可选，仅用于 `doctor`。

### 4.2 `sidecar.sh`

1. `--version <tag>`：安装必填。
2. `--relay <wss-url>`：安装时建议必填；若缺失则尝试复用已持久化 relay。
3. `--allow-insecure-ws`：可选，仅调试用途。
4. `--dry-run`：可选。
5. `--yes`：可选。
6. `--purge`：可选，仅用于 `uninstall`。
7. `--format <text|json>`：可选，仅用于 `doctor`。

## 5. sidecar CLI 契约

二进制：`yc-sidecar`

1. `yc-sidecar relay`
2. `yc-sidecar relay set <wss-url>`
3. `yc-sidecar relay -change <wss-url>`（兼容别名）
4. `yc-sidecar relay test [wss-url]`
5. `yc-sidecar relay reset`
6. `yc-sidecar pairing show --format text|json|link|qr`

## 6. 安装行为（网关+执行机）

1. relay 固定监听 `127.0.0.1:18789`。
2. nginx 对外监听 `80/443`，并反代：
   - `/healthz` -> relay
   - `/v1/ws` -> relay
   - `/` -> relay
3. `80` 端口仅允许 `/.well-known/acme-challenge/*`，其他路径统一 `404`。
4. ACME 固定为 `HTTP-01 + webroot`，不使用 DNS-01。
5. lego 固定参数：
   - `--accept-tos`
   - `--email <acme-email>`
   - `--domains <public-ip>`
   - `--profile shortlived`
   - `--http --http.webroot /var/lib/yourconnector/acme-webroot`
6. staging 模式时增加：
   - `--server https://acme-staging-v02.api.letsencrypt.org/directory`
7. 证书切换前必须通过：
   - `openssl x509 -checkend 3600`
   - SAN 包含 `public-ip`
   - 证书公钥与私钥匹配
8. 切换策略：
   - 新证书写到 `releases/<timestamp>`
   - `active` 软链接原子切换
   - `nginx -t` + `reload` 失败则回滚 `active`

## 7. 公网 IP 规则（v1）

1. 仅支持 IPv4。
2. 取值优先级：
   - `--public-ip`
   - `state.json` 中历史值
   - 自动探测
3. 自动探测顺序：
   - `https://api.ipify.org`
   - `https://ifconfig.me/ip`
   - `https://checkip.amazonaws.com`
4. 私网、回环、链路本地、CGNAT、保留网段全部视为非法并失败。

## 8. systemd 运行身份

1. `yc-relay.service`：`yourconnector` 用户。
2. `yc-sidecar.service`：`yourconnector` 用户。
3. `yc-cert-renew.service`：`root`。
4. 缺少用户时安装脚本会创建系统用户 `yourconnector`。

## 9. 固定目录

1. webroot：`/var/lib/yourconnector/acme-webroot`
2. lego state：`/var/lib/yourconnector/lego`
3. runtime state：`/var/lib/yourconnector/state.json`
4. tls：`/etc/yourconnector/tls`
5. nginx conf：`/etc/nginx/conf.d/yourconnector.conf`
6. binary：`/usr/local/bin/yc-relay`、`/usr/local/bin/yc-sidecar`

## 10. status / doctor 语义

### 10.1 `status`

1. 文本输出。
2. 全部健康返回 `0`，否则返回 `1`。

### 10.2 `doctor`

1. 支持 `--format text|json`。
2. 任一关键项失败返回 `1`。
3. JSON 至少包含：
   - `ports`
   - `certs`
   - `ip`
   - `state`
   - `nginx`
   - `systemd`
   - `nextRetryAt`

## 11. 卸载与清理边界

### 11.1 `uninstall`

1. 停止并移除 systemd 单元与二进制。
2. 保留配置、身份、证书、日志。

### 11.2 `uninstall --purge`

1. 删除身份文件：
   - `~/.config/yourconnector/sidecar/system-id.txt`
   - `~/.config/yourconnector/sidecar/pair-token.txt`
   - `~/.config/yourconnector/sidecar/config.json`
2. 删除证书、状态与日志目录。

## 12. 最小使用示例

### 12.1 网关+执行机

```bash
sudo bash /path/to/relay-sidecar.sh install \
  --version vX.Y.Z \
  --acme-email you@example.com
```

安装成功后将输出：

1. relay 地址：`wss://<公网IPv4>/v1/ws`
2. health 地址：`https://<公网IPv4>/healthz`
3. 配对信息（包含配对链接与二维码指引）

### 12.2 执行机

```bash
sudo bash /path/to/sidecar.sh install \
  --version vX.Y.Z \
  --relay wss://<公网IPv4>/v1/ws
```

## 13. GitHub Actions 自动打包发布

1. 工作流文件：`.github/workflows/release-linux.yml`
2. 触发方式：
   - 推送标签：`git push origin vX.Y.Z`
   - 手工触发：Actions -> `release-linux` -> Run workflow（填写 tag）
3. 自动产物（Release Assets）：
   - `yc-relay-linux-amd64.tar.gz`
   - `yc-sidecar-linux-amd64.tar.gz`
   - `checksums.txt`
4. 分发脚本会按 `--version` 到 Release 下载并校验 `checksums.txt`。

## 13.1 GitHub Actions 同步到 OSS（国内下载）

1. 工作流文件：`.github/workflows/sync-release-to-oss.yml`
2. 触发方式：
   - GitHub Release 发布后自动触发
   - 或手工触发并指定 tag
3. 同步路径规则：
   - `oss://<bucket>/<prefix>/<tag>/yc-relay-linux-amd64.tar.gz`
   - `oss://<bucket>/<prefix>/<tag>/yc-sidecar-linux-amd64.tar.gz`
   - `oss://<bucket>/<prefix>/<tag>/checksums.txt`
   - `oss://<bucket>/<prefix>/latest.json`
4. GitHub 仓库必须配置：
   - Secrets：`ALIYUN_ACCESS_KEY_ID`、`ALIYUN_ACCESS_KEY_SECRET`
   - Variables：`ALIYUN_OSS_BUCKET`、`ALIYUN_OSS_ENDPOINT`、`ALIYUN_OSS_DOMAIN`、`ALIYUN_OSS_PREFIX`
5. 国内用户下载地址模板：
   - `https://<ALIYUN_OSS_DOMAIN>/<ALIYUN_OSS_PREFIX>/<tag>/yc-relay-linux-amd64.tar.gz`
   - `https://<ALIYUN_OSS_DOMAIN>/<ALIYUN_OSS_PREFIX>/<tag>/yc-sidecar-linux-amd64.tar.gz`
   - `https://<ALIYUN_OSS_DOMAIN>/<ALIYUN_OSS_PREFIX>/<tag>/checksums.txt`

## 14. 验收重点（v3.3）

1. `curl http://<ip>/.well-known/acme-challenge/ping` 可达。
2. `curl http://<ip>/` 返回 `404`。
3. 证书 SAN 包含 `<ip>`。
4. default_server 冲突时安装失败，并打印冲突配置路径。
5. 人工注入坏证书后，`active` 回滚且服务不中断。
6. `doctor --format json` 返回固定结构并可用于自动化巡检。
