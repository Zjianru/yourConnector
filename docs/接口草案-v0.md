# yourConnector 接口草案 v0

## 1. 设计原则

- Relay 只做鉴权与转发，不持久化消息正文/终端输出/附件内容。
- HTTP 用于登录、配对、启动配置拉取。
- WebSocket 用于实时事件（状态、聊天、命令、终端、附件流）。
- 全事件统一包络，支持 `ack + seq + 重连续流`。

## 1.1 技术栈约定

- Mobile 客户端：Tauri（Rust），首发 iOS，后续 Android 复用同一协议。
- Sidecar：Rust，MVP 先 macOS。
- Relay-Lite：Rust。
- 协议：HTTP + WebSocket（JSON，后续可演进 Protobuf）。

## 2. 名词与 ID

- `systemId`：一台 sidecar 实例（MVP 为 macOS）。
- `toolId`：system 内某个工具实例（openclaw/opencode/...）。
- `peerId`：agent 会话对象标识。
- `sessionId`：终端会话或任务会话标识。
- `eventId`：事件唯一 ID（幂等去重）。

## 3. HTTP API（MVP）

Base URL: `https://relay.example.com/v1`

### 3.1 登录

`POST /auth/login`

Request:
```json
{
  "email": "user@example.com",
  "password": "********"
}
```

Response:
```json
{
  "userId": "usr_123",
  "accessToken": "at_xxx",
  "refreshToken": "rt_xxx",
  "expiresIn": 3600
}
```

### 3.2 刷新令牌

`POST /auth/refresh`

Request:
```json
{
  "refreshToken": "rt_xxx"
}
```

### 3.3 sidecar 申请配对码（macOS）

`POST /pairing/codes`

Headers: `Authorization: Bearer <accessToken>`

Request:
```json
{
  "deviceName": "mac-mini-home",
  "platform": "macos"
}
```

Response:
```json
{
  "pairCode": "739184",
  "expiresAt": "2026-02-19T16:00:00Z"
}
```

### 3.4 Mobile 绑定设备

`POST /pairing/claim`

Headers: `Authorization: Bearer <accessToken>`

Request:
```json
{
  "pairCode": "739184",
  "clientName": "alice-mobile"
}
```

Response:
```json
{
  "systemId": "sys_abc",
  "clientDeviceId": "mob_dev_001",
  "boundAt": "2026-02-19T16:01:00Z"
}
```

### 3.5 启动拉取（Mobile）

`GET /systems/{systemId}/bootstrap`

Headers: `Authorization: Bearer <accessToken>`

Response:
```json
{
  "system": {
    "systemId": "sys_abc",
    "name": "Home Mac",
    "status": "ONLINE"
  },
  "tools": [
    {
      "toolId": "tool_openclaw",
      "name": "OpenClaw",
      "category": "ASSISTANT",
      "status": "RUNNING"
    },
    {
      "toolId": "tool_opencode",
      "name": "OpenCode",
      "category": "DEV_WORKER",
      "status": "RUNNING"
    }
  ],
  "groups": [
    {
      "groupId": "grp_assistant",
      "name": "Assistant",
      "toolIds": ["tool_openclaw"]
    },
    {
      "groupId": "grp_dev",
      "name": "Dev Worker",
      "toolIds": ["tool_opencode"]
    }
  ]
}
```

## 4. WebSocket 通道

URL:

`wss://relay.example.com/v1/ws?clientType=mobile|sidecar&systemId=<id>&deviceId=<id>`

Headers: `Authorization: Bearer <accessToken>`

说明：
- Mobile 与 sidecar 都连接到 relay。
- relay 按 `systemId` 路由，不落库业务内容。
- 心跳超时后断开，客户端自动重连。

## 5. 统一事件包络

```json
{
  "v": 1,
  "eventId": "evt_01J...",
  "type": "terminal_output",
  "systemId": "sys_abc",
  "toolId": "tool_opencode",
  "peerId": "agent_reviewer",
  "sessionId": "term_001",
  "seq": 128,
  "ts": "2026-02-19T16:12:01.120Z",
  "ackRequired": true,
  "payload": {}
}
```

字段约定：
- `seq`：同一 `sessionId` 内严格递增。
- `ackRequired=true` 的事件需客户端回 ACK。
- `payload` 只放具体业务字段。

ACK 事件：
```json
{
  "v": 1,
  "eventId": "evt_ack_01",
  "type": "ack",
  "systemId": "sys_abc",
  "sessionId": "term_001",
  "ts": "2026-02-19T16:12:01.200Z",
  "payload": {
    "ackEventId": "evt_01J...",
    "ackSeq": 128
  }
}
```

## 6. 事件类型（MVP）

### 6.1 状态与发现
- `heartbeat`：sidecar 在线与延迟。
- `metrics_snapshot`：CPU/内存/磁盘/工具负载。
- `tools_snapshot`：当前已接入工具及状态。
- `agent_snapshot`：工具内 agent 列表更新。

### 6.2 运维与命令
- `command_request`（Mobile -> sidecar）
- `command_result`（sidecar -> Mobile）

`command_request.payload` 示例：
```json
{
  "commandKey": "restart_tool",
  "args": {
    "graceful": true
  },
  "confirmToken": "cfm_xxx"
}
```

`command_result.payload` 示例：
```json
{
  "commandKey": "restart_tool",
  "status": "SUCCESS",
  "summary": "OpenCode restarted in 2.1s",
  "rawRef": {
    "sessionId": "cmd_1002",
    "lastSeq": 18
  }
}
```

### 6.3 聊天与监视器
- `chat_message`：用户或 agent 消息。
- `agent_activity`：agent 动作流（思考/执行命令/产物生成）。
- `task_status`：任务执行进度。
- `task_result`：任务结果摘要。

`agent_activity.payload` 示例：
```json
{
  "activityType": "RUN_COMMAND",
  "title": "Running test suite",
  "detail": "pnpm test --filter api",
  "level": "INFO"
}
```

### 6.4 终端交互（必须）
- `terminal_open`
- `terminal_opened`
- `terminal_input`
- `terminal_control`
- `terminal_resize`
- `terminal_output`
- `terminal_close`
- `terminal_closed`
- `terminal_replay_request`
- `terminal_replay_chunk`

`terminal_open.payload`：
```json
{
  "toolId": "tool_opencode",
  "cols": 100,
  "rows": 28,
  "shellProfile": "default"
}
```

`terminal_input.payload`：
```json
{
  "data": "git status\n",
  "encoding": "utf8"
}
```

`terminal_control.payload`：
```json
{
  "key": "CTRL_C"
}
```

`terminal_output.payload`：
```json
{
  "chunk": "\u001b[32mPASS\u001b[0m api/user.test.ts\r\n",
  "encoding": "utf8",
  "isPartial": false
}
```

`terminal_replay_request.payload`：
```json
{
  "sessionId": "term_001",
  "fromSeqExclusive": 120
}
```

控制键枚举（MVP）：
- `CTRL_C`
- `CTRL_Z`
- `CTRL_D`
- `TAB`
- `ESC`
- `ARROW_UP`
- `ARROW_DOWN`
- `ARROW_LEFT`
- `ARROW_RIGHT`
- `ENTER`

## 7. 附件透传（不落库）

附件通过 WS 分片流转，不在 relay 落盘。

- `attachment_start`
- `attachment_chunk`
- `attachment_end`
- `attachment_abort`

`attachment_start.payload`：
```json
{
  "attachmentId": "att_01",
  "name": "voice-note.m4a",
  "mimeType": "audio/m4a",
  "size": 248182,
  "sha256": "..."
}
```

`chat_message` 仅引用：
```json
{
  "text": "请看这个语音",
  "attachments": [
    {
      "attachmentId": "att_01"
    }
  ]
}
```

## 8. 白名单与权限校验

执行链路校验顺序：
1. 认证是否有效（token + device 绑定）。
2. `system` 级白名单是否允许 `commandKey`。
3. `role/peer` 级白名单是否允许当前会话执行该命令。
4. 若命中高风险命令，校验 `confirmToken`。

返回错误统一用 `error` 事件：
```json
{
  "v": 1,
  "eventId": "evt_err_01",
  "type": "error",
  "systemId": "sys_abc",
  "ts": "2026-02-19T16:20:00Z",
  "payload": {
    "code": "COMMAND_NOT_ALLOWED",
    "message": "commandKey restart_tool is blocked by role allowlist"
  }
}
```

## 9. 断线重连规则

- Mobile/sidecar 断线后指数退避重连（1s, 2s, 4s, 8s...）。
- 重连后立即发送 `session_resume`（包含各活跃 session 的 `lastSeq`）。
- sidecar 对终端会话回放最近 N 行（内存环形缓冲）。
- relay 仅转发重连请求，不承担历史数据恢复存储。

`session_resume` 示例：
```json
{
  "v": 1,
  "eventId": "evt_resume_01",
  "type": "session_resume",
  "systemId": "sys_abc",
  "ts": "2026-02-19T16:22:00Z",
  "payload": {
    "sessions": [
      {
        "sessionId": "term_001",
        "lastSeq": 120
      }
    ]
  }
}
```

## 10. 实现建议（首版）

1. 协议编码：JSON（MVP），后续可切换 Protobuf。
2. 终端输出：原样保存 + ANSI 渲染视图双轨。
3. 事件幂等：服务端和客户端都维护 `recentEventId` 窗口。
4. 指标采样：`heartbeat` 每 5s，`metrics_snapshot` 每 10s。
5. 日志策略：relay 只记录技术指标，不记录业务负载正文。
