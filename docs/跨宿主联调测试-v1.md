# yourConnector 跨宿主联调测试 v1

## 1. 测试目标

1. 验证 A 机（云端）`relay + sidecar` 可用。
2. 验证 B 机（本地）`sidecar` 可连接 A 机 relay。
3. 验证 iOS 模拟器可完成配对并查看运维页状态。

## 2. 场景约束

1. A 机：Linux、公网 IPv4、开放 `80/443`。
2. B 机：Mac mini（开发环境）。
3. 手机端：iOS 模拟器（B 机本地）。
4. 资产来源：GitHub Release 同步到 OSS。

## 3. 准备变量

```bash
TAG=vX.Y.Z
OSS_BASE=https://<ALIYUN_OSS_DOMAIN>/<ALIYUN_OSS_PREFIX>
RELAY_WSS=wss://<A公网IPv4>/v1/ws
```

## 4. A 机安装（网关+执行机）

```bash
curl -fsSL "${OSS_BASE}/${TAG}/relay-sidecar.sh" -o relay-sidecar.sh
chmod +x relay-sidecar.sh

sudo ./relay-sidecar.sh install \
  --version "${TAG}" \
  --asset-base "${OSS_BASE}" \
  --acme-email you@example.com \
  --yes
```

验证：

```bash
sudo ./relay-sidecar.sh status
sudo ./relay-sidecar.sh doctor --format json
curl -I "https://<A公网IPv4>/healthz"
```

## 5. B 机连接（本地 sidecar）

```bash
yc-sidecar relay set "${RELAY_WSS}"
yc-sidecar relay test "${RELAY_WSS}"
RELAY_WS_URL="${RELAY_WSS}" cargo run -p yc-sidecar -- run
```

如果 B 机是 Linux，也可以使用 `sidecar.sh`：

```bash
curl -fsSL "${OSS_BASE}/${TAG}/sidecar.sh" -o sidecar.sh
chmod +x sidecar.sh
sudo ./sidecar.sh install --version "${TAG}" --asset-base "${OSS_BASE}" --relay "${RELAY_WSS}" --yes
```

## 6. iOS 模拟器测试

```bash
make run-mobile-tauri-ios IOS_SIM="iPhone 17 Pro"
```

1. 打开 Mobile，进入“添加宿主机”。
2. 输入配对链接（`yc://pair/...`）。
3. 配对成功后检查：
   - Host Snapshot 在线状态
   - Connected Tools 列表
   - 工具详情刷新

## 7. 回滚与重测

```bash
# A 机
sudo ./relay-sidecar.sh uninstall --purge --yes

# Linux B 机（若使用 sidecar.sh）
sudo ./sidecar.sh uninstall --purge --yes
```

Mac B 机开发态回滚：停止本地 `yc-sidecar` 进程并清理本地配置目录。
