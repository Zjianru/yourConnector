# yourConnector 已完成功能验收 v1

> 本文档是当前唯一“执行型验收清单”。其他文档不再维护并行验收列表。

## 1. 验收目标

确认当前版本在“配对 + 多宿主管理 + 运维展示”场景下可稳定使用，作为后续演进基线。

## 2. 验收范围

1. Relay / Sidecar / Mobile 基础链路
2. 配对三入口（扫码/图库、粘贴链接、手动配对信息）
3. 配对后设备凭证换发（`accessToken + refreshToken`）
4. 多宿主 Banner 总览与白点索引
5. Tools 按宿主机分组展示
6. 并行在线、重连上限、手动重连
7. 删除补偿队列与最终一致性删除
8. relay 统一配对签发（`/v1/pair/bootstrap`）与脚本/sidecar 一致性
9. 模块化收口（Mobile/Relay/Sidecar 深拆完成，入口瘦身）
10. 工具详情核心组件（OpenClaw + OpenCode 统一采集，OpenClaw 摘要/详情分层）
11. 系统日志与归档（`logs/raw` + `logs/archive/*.7z`）

## 3. 启动步骤

### 3.1 启动 Relay 与 Sidecar

```bash
cd /Users/codez/develop/yourConnector
make run-relay
make run-sidecar
```

健康检查（建议）：

```bash
curl -sS http://127.0.0.1:18080/healthz
curl -sS http://127.0.0.1:18081/healthz
```

### 3.2 启动 iOS App

```bash
cd /Users/codez/develop/yourConnector
make run-mobile-tauri-ios IOS_SIM="iPhone 17 Pro"
```

准备配对信息（任选其一）：

```bash
make show-pairing
make show-pairing-link
make simulate-ios-scan
```

### 3.3 执行配对

在 App 内任选入口完成配对：

1. 导入链接（粘贴 `yc://pair?...`）
2. 扫码/图库
3. 手动输入 `Relay WS URL + sid + ticket`

## 4. 验收项

### 4.0 代码门禁

1. G01 `cargo fmt --check` 通过。
2. G02 `cargo clippy --workspace --all-targets -- -D warnings` 通过。
3. G03 `cargo test --workspace` 通过。
4. G04 `find .../app/mobile/ui/js -name '*.js' -print0 | xargs -0 -I{} sh -c 'node --check "$$1" && node --check --input-type=module < "$$1"' _ "{}"` 全通过。
5. G05 `make check-governance` 通过（注释/行长/文档一致性）。

### 4.1 页面与展示

1. A01 无宿主机时展示配对页。
2. A02 有宿主机时展示 Banner 总览页。
3. A03 Banner 下方白点索引随滑动更新。
4. A04 Banner 卡片仅展示宿主机名称与在线状态。
5. A05 Tools 按宿主机分组显示。
6. A06 分组顺序按认证时间升序。
7. A06-1 已接入工具支持左滑显示“编辑/删除”操作。

### 4.2 连接行为

1. A07 启动后自动连接宿主机。
2. A08 手动断开后自动按 2 秒重连。
3. A09 连续失败 5 次后提示手动重连。
4. A10 手动重连后可恢复在线。

### 4.3 配对与命名

1. A11 四条配对路径均可触发配对。
2. A12 配对失败统一弹窗显示“原因 + 建议 + 主按钮”。
3. A13 宿主机名称重名时弹出改名引导，不影响连接。
4. A13-1 旧 `pairToken` 配对参数会被明确拒绝（`PAIR_TOKEN_NOT_SUPPORTED`）。

### 4.4 删除补偿

1. A14 Relay 可达时删除宿主机立即完成。
2. A15 Relay 不可达时宿主机先隐藏并进入删除补偿队列。
3. A16 管理页可查看“删除处理中”并手动重试。
4. A17 Relay 恢复后补偿成功并最终删除。

### 4.5 安全边界

1. A18 localStorage 不含 `pairToken/accessToken/refreshToken`。
2. A19 Keychain 可恢复设备会话并用于重连。

### 4.6 配对签发一致性

1. A20 `make show-pairing-link` 可返回 relay 签发的 `yc://pair` 链接。
2. A21 sidecar 启动后展示的 `sid/relay/hostName` 与脚本输出一致。
3. A22 `make simulate-ios-scan` 可直接触发 App 导入并完成配对。

### 4.7 工具详情链路

1. A23 打开工具详情时，App 会发送 `tool_details_refresh_request`。
2. A24 sidecar 能返回 `tool_details_snapshot` 且按 `toolId` 对齐。
3. A25 OpenClaw 摘要卡仅展示“渠道身份/默认Agent/会话诊断/混合用量头条”与网关/数据状态点。
4. A26 OpenClaw 详情页按“概览/Agents/Sessions/Usage/系统与服务”五屏展示，页内通过标签切换。
5. A27 OpenClaw Sessions 采用“诊断/时间线/台账”三分段同页展示。
6. A28 `opencode.v1` 可展示 session/model/latest tokens/model usage。
7. A29 人为制造 CLI 失败后，详情卡片显示“数据过期”，且旧值不被清空。
8. A30 OpenClaw Sessions 三分段默认落在“诊断”，并展示 24h 活跃/aborted 占比/system 占比/长时间未更新四项。
9. A31 OpenClaw Sessions 的时间线与台账使用 `K` 单位展示 token，不再混用 `M`。
10. A32 OpenClaw 详情页（概览/Agents/Sessions/系统与服务）顶部到首卡间距明显收敛，无大块空白区。
11. A33 OpenClaw 会话数据未到时显示“正在采集中”占位，不出现空白面板。
12. A41 OpenClaw Usage 仅依赖官方 CLI 与 `openclaw.json`，不读取 `custom/state` 自定义统计文件。
13. A42 OpenClaw Usage 的账号窗口百分比文案必须明确为“已使用 xx%”，并展示重置时间。
14. A43 OpenClaw Usage 必须展示配置全量模型，按“1h 内有无 token 活动”分为“已产生费用模型/未产生费用模型”。
15. A44 OpenClaw Usage 的 API 消耗必须按 provider 聚合为单卡展示，卡内列该 provider 的已消耗模型明细。

### 4.8 系统日志与归档

1. A34 启动 relay 与 sidecar 后，`/Users/codez/develop/yourConnector/logs/raw` 出现当日日志文件（`relay.log.YYYY-MM-DD`、`sidecar.log.YYYY-MM-DD`）。
2. A35 当 `RUST_LOG=warn` 时，文件日志仍可记录 `info` 级系统事件（由 `YC_FILE_LOG_LEVEL` 单独控制）。
3. A36 `logs/raw` 中“早于今天”的日志会被自动归档到 `logs/archive/YYYY-MM-DD.7z`。
4. A37 归档成功后，对应 `logs/raw` 历史文件被删除。
5. A38 归档目录中若已存在同名 `.7z`，重复归档不会导致服务崩溃或死锁。
6. A39 relay/sidecar 链路日志包含 `event_id` 与 `trace_id` 摘要字段，可用于跨端追踪。
7. A40 Mobile 调试页支持复制结构化日志 JSON，且条目包含 `traceId/eventId/eventType/hostId/toolId`。

## 5. 验收记录

1. 验收日期：`待填写`
2. 验收人：`待填写`
3. 结论：`待填写（通过 / 有条件通过 / 不通过）`

## 6. 当前说明

1. 多宿主真实联调待接入第二台宿主机后执行手工验收。
2. 自动化回归在后续迭代补齐。
